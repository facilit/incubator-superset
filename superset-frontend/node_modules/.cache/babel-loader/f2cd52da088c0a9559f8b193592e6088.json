{"ast":null,"code":"import _extends from \"@babel/runtime-corejs3/helpers/extends\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _objectWithoutPropertiesLoose from \"@babel/runtime-corejs3/helpers/objectWithoutPropertiesLoose\";import _setTimeout from \"@babel/runtime-corejs3/core-js-stable/set-timeout\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _concatInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/concat\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport {\nButton,\nControlLabel,\nFormGroup,\nPopover,\nTab,\nTabs } from\n'react-bootstrap';\nimport Select from 'src/components/Select';\nimport ace from 'brace';\nimport AceEditor from 'react-ace';\nimport 'brace/mode/sql';\nimport 'brace/theme/github';\nimport 'brace/ext/language_tools';\nimport { t } from '@superset-ui/translation';\nimport { ColumnOption } from '@superset-ui/chart-controls';\n\nimport { AGGREGATES, AGGREGATES_OPTIONS } from '../constants';\nimport AdhocMetricEditPopoverTitle from './AdhocMetricEditPopoverTitle';\nimport columnType from '../propTypes/columnType';\nimport AdhocMetric, { EXPRESSION_TYPES } from '../AdhocMetric';\nimport sqlKeywords from '../../SqlLab/utils/sqlKeywords';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst langTools = ace.acequire('ace/ext/language_tools');\n\nconst propTypes = {\n  adhocMetric: PropTypes.instanceOf(AdhocMetric).isRequired,\n  onChange: PropTypes.func.isRequired,\n  onClose: PropTypes.func.isRequired,\n  onResize: PropTypes.func.isRequired,\n  columns: PropTypes.arrayOf(columnType),\n  datasourceType: PropTypes.string };\n\n\nconst defaultProps = {\n  columns: [] };\n\n\nconst startingWidth = 300;\nconst startingHeight = 180;\n\nexport default class AdhocMetricEditPopover extends React.Component {\n  constructor(props) {var _context, _context2, _context3, _context4, _context5, _context6, _context7, _context8, _context9, _context10;\n    super(props);\n    this.onSave = _bindInstanceProperty(_context = this.onSave).call(_context, this);\n    this.onColumnChange = _bindInstanceProperty(_context2 = this.onColumnChange).call(_context2, this);\n    this.onAggregateChange = _bindInstanceProperty(_context3 = this.onAggregateChange).call(_context3, this);\n    this.onSqlExpressionChange = _bindInstanceProperty(_context4 = this.onSqlExpressionChange).call(_context4, this);\n    this.onLabelChange = _bindInstanceProperty(_context5 = this.onLabelChange).call(_context5, this);\n    this.onDragDown = _bindInstanceProperty(_context6 = this.onDragDown).call(_context6, this);\n    this.onMouseMove = _bindInstanceProperty(_context7 = this.onMouseMove).call(_context7, this);\n    this.onMouseUp = _bindInstanceProperty(_context8 = this.onMouseUp).call(_context8, this);\n    this.handleAceEditorRef = _bindInstanceProperty(_context9 = this.handleAceEditorRef).call(_context9, this);\n    this.refreshAceEditor = _bindInstanceProperty(_context10 = this.refreshAceEditor).call(_context10, this);\n    this.state = {\n      adhocMetric: this.props.adhocMetric,\n      width: startingWidth,\n      height: startingHeight };\n\n    this.selectProps = {\n      labelKey: 'label',\n      isMulti: false,\n      autosize: false,\n      clearable: true };\n\n    if (langTools) {var _context11;\n      const words = _concatInstanceProperty(sqlKeywords).call(sqlKeywords,\n      _mapInstanceProperty(_context11 = this.props.columns).call(_context11, column => ({\n        name: column.column_name,\n        value: column.column_name,\n        score: 50,\n        meta: 'column' })));\n\n\n      const completer = {\n        getCompletions: (aceEditor, session, pos, prefix, callback) => {\n          callback(null, words);\n        } };\n\n      langTools.setCompleters([completer]);\n    }\n    document.addEventListener('mouseup', this.onMouseUp);\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('mouseup', this.onMouseUp);\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  onSave() {\n    this.props.onChange(this.state.adhocMetric);\n    this.props.onClose();\n  }\n\n  onColumnChange(column) {\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        column,\n        expressionType: EXPRESSION_TYPES.SIMPLE }) });\n\n\n  }\n\n  onAggregateChange(aggregate) {\n    // we construct this object explicitly to overwrite the value in the case aggregate is null\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        aggregate,\n        expressionType: EXPRESSION_TYPES.SIMPLE }) });\n\n\n  }\n\n  onSqlExpressionChange(sqlExpression) {\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        sqlExpression,\n        expressionType: EXPRESSION_TYPES.SQL }) });\n\n\n  }\n\n  onLabelChange(e) {\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        label: e.target.value,\n        hasCustomLabel: true }) });\n\n\n  }\n\n  onDragDown(e) {\n    this.dragStartX = e.clientX;\n    this.dragStartY = e.clientY;\n    this.dragStartWidth = this.state.width;\n    this.dragStartHeight = this.state.height;\n    document.addEventListener('mousemove', this.onMouseMove);\n  }\n\n  onMouseMove(e) {\n    this.props.onResize();\n    this.setState({\n      width: Math.max(\n      this.dragStartWidth + (e.clientX - this.dragStartX),\n      startingWidth),\n\n      height: Math.max(\n      this.dragStartHeight + (e.clientY - this.dragStartY) * 2,\n      startingHeight) });\n\n\n  }\n\n  onMouseUp() {\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  handleAceEditorRef(ref) {\n    if (ref) {\n      this.aceEditorRef = ref;\n    }\n  }\n\n  refreshAceEditor() {\n    _setTimeout(() => this.aceEditorRef.editor.resize(), 0);\n  }\n\n  renderColumnOption(option) {\n    return ___EmotionJSX(ColumnOption, { column: option, showType: true });\n  }\n\n  render() {\n    const _this$props =\n\n\n\n\n\n\n\n    this.props,{ adhocMetric: propsAdhocMetric, columns } = _this$props,popoverProps = _objectWithoutPropertiesLoose(_this$props, [\"adhocMetric\", \"columns\", \"onChange\", \"onClose\", \"onResize\", \"datasourceType\"]);\n\n    const { adhocMetric } = this.state;\n\n    const columnSelectProps = {\n      placeholder: t('%s column(s)', columns.length),\n      options: columns,\n      value:\n      adhocMetric.column && adhocMetric.column.column_name ||\n      adhocMetric.inferSqlExpressionColumn(),\n      onChange: this.onColumnChange,\n      optionRenderer: this.renderColumnOption,\n      valueKey: 'column_name' };\n\n\n    const aggregateSelectProps = {\n      placeholder: t('%s aggregates(s)', AGGREGATES_OPTIONS.length),\n      options: AGGREGATES_OPTIONS,\n      value: adhocMetric.aggregate || adhocMetric.inferSqlExpressionAggregate(),\n      onChange: this.onAggregateChange };\n\n\n    if (this.props.datasourceType === 'druid') {var _context12;\n      aggregateSelectProps.options = _filterInstanceProperty(_context12 = aggregateSelectProps.options).call(_context12,\n      aggregate => aggregate !== 'AVG');\n\n    }\n\n    const popoverTitle =\n    ___EmotionJSX(AdhocMetricEditPopoverTitle, {\n      adhocMetric: adhocMetric,\n      onChange: this.onLabelChange });\n\n\n\n    const stateIsValid = adhocMetric.isValid();\n    const hasUnsavedChanges = !adhocMetric.equals(propsAdhocMetric);\n    return (\n      ___EmotionJSX(Popover, _extends({ id: \"metrics-edit-popover\", title: popoverTitle }, popoverProps),\n      ___EmotionJSX(Tabs, {\n        id: \"adhoc-metric-edit-tabs\",\n        defaultActiveKey: adhocMetric.expressionType,\n        className: \"adhoc-metric-edit-tabs\",\n        style: { height: this.state.height, width: this.state.width },\n        onSelect: this.refreshAceEditor,\n        animation: false },\n\n      ___EmotionJSX(Tab, {\n        className: \"adhoc-metric-edit-tab\",\n        eventKey: EXPRESSION_TYPES.SIMPLE,\n        title: \"Simple\" },\n\n      ___EmotionJSX(FormGroup, null,\n      ___EmotionJSX(ControlLabel, null,\n      ___EmotionJSX(\"strong\", null, \"column\")),\n\n      ___EmotionJSX(Select, _extends({\n        name: \"select-column\" },\n      this.selectProps,\n      columnSelectProps))),\n\n\n      ___EmotionJSX(FormGroup, null,\n      ___EmotionJSX(ControlLabel, null,\n      ___EmotionJSX(\"strong\", null, \"aggregate\")),\n\n      ___EmotionJSX(Select, _extends({\n        name: \"select-aggregate\" },\n      this.selectProps,\n      aggregateSelectProps, {\n        autoFocus: true })))),\n\n\n\n      ___EmotionJSX(Tab, {\n        className: \"adhoc-metric-edit-tab\",\n        eventKey: EXPRESSION_TYPES.SQL,\n        title: \"Custom SQL\" },\n\n      this.props.datasourceType !== 'druid' ?\n      ___EmotionJSX(FormGroup, null,\n      ___EmotionJSX(AceEditor, {\n        ref: this.handleAceEditorRef,\n        mode: \"sql\",\n        theme: \"github\",\n        height: this.state.height - 43 + 'px',\n        onChange: this.onSqlExpressionChange,\n        width: \"100%\",\n        showGutter: false,\n        value:\n        adhocMetric.sqlExpression || adhocMetric.translateToSql(),\n\n        editorProps: { $blockScrolling: true },\n        enableLiveAutocompletion: true,\n        className: \"adhoc-filter-sql-editor\",\n        wrapEnabled: true })) :\n\n\n\n      ___EmotionJSX(\"div\", { className: \"custom-sql-disabled-message\" }, \"Custom SQL Metrics are not available on druid datasources\"))),\n\n\n\n\n\n      ___EmotionJSX(\"div\", null,\n      ___EmotionJSX(Button, {\n        disabled: !stateIsValid,\n        bsStyle: hasUnsavedChanges && stateIsValid ? 'primary' : 'default',\n        bsSize: \"small\",\n        className: \"m-r-5\",\n        onClick: this.onSave }, \"Save\"),\n\n\n\n      ___EmotionJSX(Button, { bsSize: \"small\", onClick: this.props.onClose }, \"Close\"),\n\n\n      ___EmotionJSX(\"i\", {\n        onMouseDown: this.onDragDown,\n        className: \"fa fa-expand edit-popover-resize text-muted\" }))));\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}AdhocMetricEditPopover.propTypes = propTypes;\nAdhocMetricEditPopover.defaultProps = defaultProps;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(langTools, \"langTools\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");reactHotLoader.register(propTypes, \"propTypes\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");reactHotLoader.register(defaultProps, \"defaultProps\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");reactHotLoader.register(startingWidth, \"startingWidth\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");reactHotLoader.register(startingHeight, \"startingHeight\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");reactHotLoader.register(AdhocMetricEditPopover, \"AdhocMetricEditPopover\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":null,"metadata":{},"sourceType":"module"}