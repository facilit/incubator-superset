{"ast":null,"code":"import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _sliceInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/slice\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { Button } from 'react-bootstrap';\nimport Select from 'src/components/Select';\nimport { t } from '@superset-ui/translation';\nimport { SupersetClient } from '@superset-ui/connection';\n\nimport Loading from '../../components/Loading';\nimport QueryTable from './QueryTable';\nimport {\nnow,\nepochTimeXHoursAgo,\nepochTimeXDaysAgo,\nepochTimeXYearsAgo } from\n'../../modules/dates';\nimport { STATUS_OPTIONS, TIME_OPTIONS } from '../constants';\nimport AsyncSelect from '../../components/AsyncSelect';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst propTypes = {\n  actions: PropTypes.object.isRequired,\n  height: PropTypes.string.isRequired,\n  displayLimit: PropTypes.number.isRequired };\n\n\nclass QuerySearch extends React.PureComponent {\n  constructor(props) {var _context, _context2, _context3, _context4, _context5, _context6, _context7, _context8, _context9, _context10, _context11, _context12;\n    super(props);\n    this.state = {\n      userLoading: false,\n      userOptions: [],\n      databaseId: null,\n      userId: null,\n      searchText: null,\n      from: '28 days ago',\n      to: 'now',\n      status: 'success',\n      queriesArray: [],\n      queriesLoading: true };\n\n    this.userMutator = _bindInstanceProperty(_context = this.userMutator).call(_context, this);\n    this.changeUser = _bindInstanceProperty(_context2 = this.changeUser).call(_context2, this);\n    this.dbMutator = _bindInstanceProperty(_context3 = this.dbMutator).call(_context3, this);\n    this.onChange = _bindInstanceProperty(_context4 = this.onChange).call(_context4, this);\n    this.changeSearch = _bindInstanceProperty(_context5 = this.changeSearch).call(_context5, this);\n    this.onKeyDown = _bindInstanceProperty(_context6 = this.onKeyDown).call(_context6, this);\n    this.changeFrom = _bindInstanceProperty(_context7 = this.changeFrom).call(_context7, this);\n    this.changeTo = _bindInstanceProperty(_context8 = this.changeTo).call(_context8, this);\n    this.changeStatus = _bindInstanceProperty(_context9 = this.changeStatus).call(_context9, this);\n    this.refreshQueries = _bindInstanceProperty(_context10 = this.refreshQueries).call(_context10, this);\n    this.onUserClicked = _bindInstanceProperty(_context11 = this.onUserClicked).call(_context11, this);\n    this.onDbClicked = _bindInstanceProperty(_context12 = this.onDbClicked).call(_context12, this);\n  }\n\n  componentDidMount() {\n    this.refreshQueries();\n  }\n\n  onUserClicked(userId) {\n    this.setState({ userId }, () => {\n      this.refreshQueries();\n    });\n  }\n\n  onDbClicked(dbId) {\n    this.setState({ databaseId: dbId }, () => {\n      this.refreshQueries();\n    });\n  }\n\n  onChange(db) {\n    const val = db ? db.value : null;\n    this.setState({ databaseId: val });\n  }\n\n  onKeyDown(event) {\n    if (event.keyCode === 13) {\n      this.refreshQueries();\n    }\n  }\n\n  getTimeFromSelection(selection) {\n    switch (selection) {\n      case 'now':\n        return now();\n      case '1 hour ago':\n        return epochTimeXHoursAgo(1);\n      case '1 day ago':\n        return epochTimeXDaysAgo(1);\n      case '7 days ago':\n        return epochTimeXDaysAgo(7);\n      case '28 days ago':\n        return epochTimeXDaysAgo(28);\n      case '90 days ago':\n        return epochTimeXDaysAgo(90);\n      case '1 year ago':\n        return epochTimeXYearsAgo(1);\n      default:\n        return null;}\n\n  }\n\n  changeFrom(user) {\n    const val = user ? user.value : null;\n    this.setState({ from: val });\n  }\n\n  changeTo(status) {\n    const val = status ? status.value : null;\n    this.setState({ to: val });\n  }\n\n  changeUser(user) {\n    const val = user ? user.value : null;\n    this.setState({ userId: val });\n  }\n\n  insertParams(baseUrl, params) {\n    const validParams = _filterInstanceProperty(params).call(params, function (p) {\n      return p !== '';\n    });\n    return baseUrl + '?' + validParams.join('&');\n  }\n\n  changeStatus(status) {\n    const val = status ? status.value : null;\n    this.setState({ status: val });\n  }\n\n  changeSearch(event) {\n    this.setState({ searchText: event.target.value });\n  }\n\n  userLabel(user) {\n    if (user.first_name && user.last_name) {\n      return user.first_name + ' ' + user.last_name;\n    }\n    return user.username;\n  }\n\n  userMutator(data) {\n    const options = [];\n    for (let i = 0; i < data.pks.length; i++) {\n      options.push({\n        value: data.pks[i],\n        label: this.userLabel(data.result[i]) });\n\n    }\n    return options;\n  }\n\n  dbMutator(data) {var _context13;\n    const options = _mapInstanceProperty(_context13 = data.result).call(_context13, db => ({\n      value: db.id,\n      label: db.database_name }));\n\n    this.props.actions.setDatabases(data.result);\n    if (data.result.length === 0) {\n      this.props.actions.addDangerToast(\n      t(\"It seems you don't have access to any database\"));\n\n    }\n    return options;\n  }\n\n  refreshQueries() {\n    this.setState({ queriesLoading: true });\n    const params = [\n    this.state.userId ? \"user_id=\" + this.state.userId : '',\n    this.state.databaseId ? \"database_id=\" + this.state.databaseId : '',\n    this.state.searchText ? \"search_text=\" + this.state.searchText : '',\n    this.state.status ? \"status=\" + this.state.status : '',\n    this.state.from ? \"from=\" +\n    this.getTimeFromSelection(this.state.from) :\n    '',\n    this.state.to ? \"to=\" + this.getTimeFromSelection(this.state.to) : ''];\n\n\n    SupersetClient.get({\n      endpoint: this.insertParams('/superset/search_queries', params) }).\n\n    then(({ json }) => {\n      this.setState({ queriesArray: json, queriesLoading: false });\n    }).\n    catch(() => {\n      this.props.actions.addDangerToast(\n      t('An error occurred when refreshing queries'));\n\n    });\n  }\n\n  render() {var _context14, _context15;\n    return (\n      ___EmotionJSX(\"div\", null,\n      ___EmotionJSX(\"div\", { id: \"search-header\", className: \"row space-1\" },\n      ___EmotionJSX(\"div\", { className: \"col-sm-2\" },\n      ___EmotionJSX(AsyncSelect, {\n        dataEndpoint: \"/users/api/read\",\n        mutator: this.userMutator,\n        value: this.state.userId,\n        onChange: this.changeUser,\n        placeholder: t('Filter by user') })),\n\n\n      ___EmotionJSX(\"div\", { className: \"col-sm-2\" },\n      ___EmotionJSX(AsyncSelect, {\n        onChange: this.onChange,\n        dataEndpoint: \"/api/v1/database/?q=(filters:!((col:expose_in_sqllab,opr:eq,value:!t)))\",\n        value: this.state.databaseId,\n        mutator: this.dbMutator,\n        placeholder: t('Filter by database') })),\n\n\n      ___EmotionJSX(\"div\", { className: \"col-sm-4\" },\n      ___EmotionJSX(\"input\", {\n        type: \"text\",\n        onChange: this.changeSearch,\n        onKeyDown: this.onKeyDown,\n        className: \"form-control input-sm\",\n        placeholder: t('Query search string') })),\n\n\n      ___EmotionJSX(\"div\", { className: \"col-sm-4 search-date-filter-container\" },\n      ___EmotionJSX(Select, {\n        name: \"select-from\",\n        placeholder: t('[From]-'),\n        options: _mapInstanceProperty(_context14 = _sliceInstanceProperty(TIME_OPTIONS).call(TIME_OPTIONS, 1, TIME_OPTIONS.length)).call(_context14, xt => ({\n          value: xt,\n          label: xt })),\n\n        value: this.state.from,\n        autosize: false,\n        onChange: this.changeFrom }),\n\n\n      ___EmotionJSX(Select, {\n        name: \"select-to\",\n        placeholder: t('[To]-'),\n        options: _mapInstanceProperty(TIME_OPTIONS).call(TIME_OPTIONS, xt => ({ value: xt, label: xt })),\n        value: this.state.to,\n        autosize: false,\n        onChange: this.changeTo }),\n\n\n      ___EmotionJSX(Select, {\n        name: \"select-status\",\n        placeholder: t('Filter by status'),\n        options: _mapInstanceProperty(_context15 = _Object$keys(STATUS_OPTIONS)).call(_context15, s => ({\n          value: s,\n          label: s })),\n\n        value: this.state.status,\n        isLoading: false,\n        autosize: false,\n        onChange: this.changeStatus }),\n\n\n      ___EmotionJSX(Button, {\n        bsSize: \"small\",\n        bsStyle: \"success\",\n        onClick: this.refreshQueries },\n\n      t('Search')))),\n\n\n\n      ___EmotionJSX(\"div\", { className: \"scrollbar-container\" },\n      this.state.queriesLoading ?\n      ___EmotionJSX(Loading, null) :\n\n      ___EmotionJSX(\"div\", {\n        className: \"scrollbar-content\",\n        style: { height: this.props.height } },\n\n      ___EmotionJSX(QueryTable, {\n        columns: [\n        'state',\n        'db',\n        'user',\n        'time',\n        'progress',\n        'rows',\n        'sql',\n        'querylink'],\n\n        onUserClicked: this.onUserClicked,\n        onDbClicked: this.onDbClicked,\n        queries: this.state.queriesArray,\n        actions: this.props.actions,\n        displayLimit: this.props.displayLimit })))));\n\n\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}QuerySearch.propTypes = propTypes;const _default =\nQuerySearch;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(propTypes, \"propTypes\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");reactHotLoader.register(QuerySearch, \"QuerySearch\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");reactHotLoader.register(_default, \"default\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":null,"metadata":{},"sourceType":"module"}