{"ast":null,"code":"import _sliceInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/slice\";import _Object$assign from \"@babel/runtime-corejs3/core-js-stable/object/assign\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    */\n/* eslint-disable camelcase */\n/* eslint prefer-const: 2 */\nimport shortid from 'shortid';\nimport { SupersetClient } from '@superset-ui/connection';\n\nimport { safeStringify } from '../utils/safeStringify';\nimport { LOG_EVENT } from '../logger/actions';\nimport { LOG_EVENT_TYPE_TIMING } from '../logger/LogUtils';\nimport DebouncedMessageQueue from '../utils/DebouncedMessageQueue';\n\nconst LOG_ENDPOINT = '/superset/log/?explode=events';\nconst sendBeacon = events => {\n  if (events.length <= 0) {\n    return;\n  }\n\n  let endpoint = LOG_ENDPOINT;\n  const { source, source_id } = events[0];\n  // backend logs treat these request params as first-class citizens\n  if (source === 'dashboard') {\n    endpoint += \"&dashboard_id=\" + source_id;\n  } else if (source === 'slice') {\n    endpoint += \"&slice_id=\" + source_id;\n  }\n\n  if (navigator.sendBeacon) {\n    const formData = new FormData();\n    formData.append('events', safeStringify(events));\n    navigator.sendBeacon(endpoint, formData);\n  } else {\n    SupersetClient.post({\n      endpoint,\n      postPayload: { events },\n      parseMethod: null });\n\n  }\n};\n\n// beacon API has data size limit = 2^16.\n// assume avg each log entry has 2^6 characters\nconst MAX_EVENTS_PER_REQUEST = 1024;\nconst logMessageQueue = new DebouncedMessageQueue({\n  callback: sendBeacon,\n  sizeThreshold: MAX_EVENTS_PER_REQUEST,\n  delayThreshold: 1000 });\n\nlet lastEventId = 0;\nconst loggerMiddleware = store => next => action => {\n  if (action.type !== LOG_EVENT) {\n    return next(action);\n  }\n\n  const {\n    dashboardInfo,\n    explore,\n    impressionId,\n    dashboardLayout } =\n  store.getState();\n  let logMetadata = {\n    impression_id: impressionId,\n    version: 'v2' };\n\n  if (dashboardInfo) {\n    logMetadata = _Object$assign({\n      source: 'dashboard',\n      source_id: dashboardInfo.id },\n    logMetadata);\n\n  } else if (explore) {\n    logMetadata = _Object$assign({\n      source: 'slice',\n      source_id: _sliceInstanceProperty(explore) ? _sliceInstanceProperty(explore).slice_id : 0 },\n    logMetadata);\n\n  }\n\n  const { eventName } = action.payload;\n  let { eventData = {} } = action.payload;\n  eventData = _Object$assign({},\n  logMetadata, {\n    ts: new Date().getTime(),\n    event_name: eventName },\n  eventData);\n\n  if (LOG_EVENT_TYPE_TIMING.has(eventName)) {\n    eventData = _Object$assign({},\n    eventData, {\n      event_type: 'timing',\n      trigger_event: lastEventId });\n\n  } else {\n    lastEventId = shortid.generate();\n    eventData = _Object$assign({},\n    eventData, {\n      event_type: 'user',\n      event_id: lastEventId,\n      visibility: document.visibilityState });\n\n  }\n\n  if (eventData.target_id && dashboardLayout.present) {\n    const meta = dashboardLayout.present[eventData.target_id].meta;\n    // chart name or tab/header text\n    eventData.target_name = meta.chartId ? meta.sliceName : meta.text;\n  }\n\n  logMessageQueue.append(eventData);\n  return eventData;\n};const _default =\n\nloggerMiddleware;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(LOG_ENDPOINT, \"LOG_ENDPOINT\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(sendBeacon, \"sendBeacon\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(MAX_EVENTS_PER_REQUEST, \"MAX_EVENTS_PER_REQUEST\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(logMessageQueue, \"logMessageQueue\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(lastEventId, \"lastEventId\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(loggerMiddleware, \"loggerMiddleware\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(_default, \"default\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/middleware/loggerMiddleware.js\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":null,"metadata":{},"sourceType":"module"}