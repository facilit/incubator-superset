{"ast":null,"code":"import _Object$assign from \"@babel/runtime-corejs3/core-js-stable/object/assign\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport ReactMarkdown from 'react-markdown';\nimport cx from 'classnames';\nimport AceEditor from 'react-ace';\nimport 'brace/mode/markdown';\nimport 'brace/theme/textmate';\nimport { t } from '@superset-ui/translation';\n\nimport DeleteComponentButton from '../DeleteComponentButton';\nimport DragDroppable from '../dnd/DragDroppable';\nimport ResizableContainer from '../resizable/ResizableContainer';\nimport MarkdownModeDropdown from '../menu/MarkdownModeDropdown';\nimport WithPopoverMenu from '../menu/WithPopoverMenu';\nimport { componentShape } from '../../util/propShapes';\nimport { ROW_TYPE, COLUMN_TYPE } from '../../util/componentTypes';\nimport {\nGRID_MIN_COLUMN_COUNT,\nGRID_MIN_ROW_UNITS,\nGRID_BASE_UNIT } from\n'../../util/constants';\nimport { Logger, LOG_ACTIONS_RENDER_CHART } from '../../../logger/LogUtils';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst propTypes = {\n  id: PropTypes.string.isRequired,\n  parentId: PropTypes.string.isRequired,\n  component: componentShape.isRequired,\n  parentComponent: componentShape.isRequired,\n  index: PropTypes.number.isRequired,\n  depth: PropTypes.number.isRequired,\n  editMode: PropTypes.bool.isRequired,\n\n  // from redux\n  logEvent: PropTypes.func.isRequired,\n  addDangerToast: PropTypes.func.isRequired,\n  undoLength: PropTypes.number.isRequired,\n  redoLength: PropTypes.number.isRequired,\n\n  // grid related\n  availableColumnCount: PropTypes.number.isRequired,\n  columnWidth: PropTypes.number.isRequired,\n  onResizeStart: PropTypes.func.isRequired,\n  onResize: PropTypes.func.isRequired,\n  onResizeStop: PropTypes.func.isRequired,\n\n  // dnd\n  deleteComponent: PropTypes.func.isRequired,\n  handleComponentDrop: PropTypes.func.isRequired,\n  updateComponents: PropTypes.func.isRequired };\n\n\nconst defaultProps = {};\n\nconst MARKDOWN_PLACE_HOLDER = \"# \\u2728Markdown\\n## \\u2728Markdown\\n### \\u2728Markdown\\n\\n<br />\\n\\nClick here to edit [markdown](https://bit.ly/1dQOfRK)\";\n\n\n\n\n\n\n\nconst MARKDOWN_ERROR_MESSAGE = t('This markdown component has an error.');\n\nfunction isSafeMarkup(node) {\n  if (node.type === 'html') {\n    return /href=\"(javascript|vbscript|file):.*\"/gim.test(node.value) === false;\n  }\n\n  return true;\n}\nclass Markdown extends React.PureComponent {\n  constructor(props) {var _context, _context2, _context3, _context4, _context5;\n    super(props);\n    this.state = {\n      isFocused: false,\n      markdownSource: props.component.meta.code,\n      editor: null,\n      editorMode: 'preview',\n      undoLength: props.undoLength,\n      redoLength: props.redoLength };\n\n    this.renderStartTime = Logger.getTimestamp();\n\n    this.handleChangeFocus = _bindInstanceProperty(_context = this.handleChangeFocus).call(_context, this);\n    this.handleChangeEditorMode = _bindInstanceProperty(_context2 = this.handleChangeEditorMode).call(_context2, this);\n    this.handleMarkdownChange = _bindInstanceProperty(_context3 = this.handleMarkdownChange).call(_context3, this);\n    this.handleDeleteComponent = _bindInstanceProperty(_context4 = this.handleDeleteComponent).call(_context4, this);\n    this.setEditor = _bindInstanceProperty(_context5 = this.setEditor).call(_context5, this);\n  }\n\n  componentDidMount() {\n    this.props.logEvent(LOG_ACTIONS_RENDER_CHART, {\n      viz_type: 'markdown',\n      start_offset: this.renderStartTime,\n      ts: new Date().getTime(),\n      duration: Logger.getTimestamp() - this.renderStartTime });\n\n  }\n\n  static getDerivedStateFromProps(nextProps, state) {\n    const {\n      hasError,\n      editorMode,\n      markdownSource,\n      undoLength,\n      redoLength } =\n    state;\n    const {\n      component: nextComponent,\n      undoLength: nextUndoLength,\n      redoLength: nextRedoLength } =\n    nextProps;\n    // user click undo or redo ?\n    if (nextUndoLength !== undoLength || nextRedoLength !== redoLength) {\n      return _Object$assign({},\n      state, {\n        undoLength: nextUndoLength,\n        redoLength: nextRedoLength,\n        markdownSource: nextComponent.meta.code,\n        hasError: false });\n\n    } else if (\n    !hasError &&\n    editorMode === 'preview' &&\n    nextComponent.meta.code !== markdownSource)\n    {\n      return _Object$assign({},\n      state, {\n        markdownSource: nextComponent.meta.code });\n\n    }\n\n    return state;\n  }\n\n  static getDerivedStateFromError() {\n    return {\n      hasError: true };\n\n  }\n\n  componentDidUpdate(prevProps) {\n    if (\n    this.state.editor && (\n    prevProps.component.meta.width !== this.props.component.meta.width ||\n    prevProps.columnWidth !== this.props.columnWidth))\n    {\n      this.state.editor.resize(true);\n    }\n  }\n\n  componentDidCatch(error, info) {\n    if (this.state.editor && this.state.editorMode === 'preview') {\n      this.props.addDangerToast(\n      t(\n      'This markdown component has an error. Please revert your recent changes.'));\n\n\n    }\n  }\n\n  setEditor(editor) {\n    editor.getSession().setUseWrapMode(true);\n    this.setState({\n      editor });\n\n  }\n\n  handleChangeFocus(nextFocus) {\n    const nextFocused = !!nextFocus;\n    const nextEditMode = nextFocused ? 'edit' : 'preview';\n    this.setState(() => ({ isFocused: nextFocused }));\n    this.handleChangeEditorMode(nextEditMode);\n  }\n\n  handleChangeEditorMode(mode) {\n    const nextState = _Object$assign({},\n    this.state, {\n      editorMode: mode });\n\n\n    if (mode === 'preview') {\n      const { updateComponents, component } = this.props;\n      if (component.meta.code !== this.state.markdownSource) {\n        updateComponents({\n          [component.id]: _Object$assign({},\n          component, {\n            meta: _Object$assign({},\n            component.meta, {\n              code: this.state.markdownSource }) }) });\n\n\n\n      }\n      nextState.hasError = false;\n    }\n\n    this.setState(nextState);\n  }\n\n  handleMarkdownChange(nextValue) {\n    this.setState({\n      markdownSource: nextValue });\n\n  }\n\n  handleDeleteComponent() {\n    const { deleteComponent, id, parentId } = this.props;\n    deleteComponent(id, parentId);\n  }\n\n  renderEditMode() {\n    return (\n      ___EmotionJSX(AceEditor, {\n        mode: \"markdown\",\n        theme: \"textmate\",\n        onChange: this.handleMarkdownChange,\n        width: \"100%\",\n        height: \"100%\",\n        showGutter: false,\n        editorProps: { $blockScrolling: true },\n        value:\n        // thisl allows \"select all => delete\" to give an empty editor\n        typeof this.state.markdownSource === 'string' ?\n        this.state.markdownSource :\n        MARKDOWN_PLACE_HOLDER,\n\n        readOnly: false,\n        onLoad: this.setEditor }));\n\n\n  }\n\n  renderPreviewMode() {\n    const { hasError } = this.state;\n    return (\n      ___EmotionJSX(ReactMarkdown, {\n        source:\n        hasError ?\n        MARKDOWN_ERROR_MESSAGE :\n        this.state.markdownSource || MARKDOWN_PLACE_HOLDER,\n\n        escapeHtml: false,\n        allowNode: isSafeMarkup }));\n\n\n  }\n\n  render() {\n    const { isFocused, editorMode } = this.state;\n\n    const {\n      component,\n      parentComponent,\n      index,\n      depth,\n      availableColumnCount,\n      columnWidth,\n      onResizeStart,\n      onResize,\n      onResizeStop,\n      handleComponentDrop,\n      editMode } =\n    this.props;\n\n    // inherit the size of parent columns\n    const widthMultiple =\n    parentComponent.type === COLUMN_TYPE ?\n    parentComponent.meta.width || GRID_MIN_COLUMN_COUNT :\n    component.meta.width || GRID_MIN_COLUMN_COUNT;\n\n    const isEditing = editorMode === 'edit';\n\n    return (\n      ___EmotionJSX(DragDroppable, {\n        component: component,\n        parentComponent: parentComponent,\n        orientation: parentComponent.type === ROW_TYPE ? 'column' : 'row',\n        index: index,\n        depth: depth,\n        onDrop: handleComponentDrop,\n        disableDragDrop: isFocused,\n        editMode: editMode },\n\n      ({ dropIndicatorProps, dragSourceRef }) =>\n      ___EmotionJSX(WithPopoverMenu, {\n        onChangeFocus: this.handleChangeFocus,\n        menuItems: [\n        ___EmotionJSX(MarkdownModeDropdown, {\n          id: component.id + \"-mode\",\n          value: this.state.editorMode,\n          onChange: this.handleChangeEditorMode }),\n\n        ___EmotionJSX(DeleteComponentButton, { onDelete: this.handleDeleteComponent })],\n\n        editMode: editMode },\n\n      ___EmotionJSX(\"div\", {\n        className: cx(\n        'dashboard-markdown',\n        isEditing && 'dashboard-markdown--editing') },\n\n\n      ___EmotionJSX(ResizableContainer, {\n        id: component.id,\n        adjustableWidth: parentComponent.type === ROW_TYPE,\n        adjustableHeight: true,\n        widthStep: columnWidth,\n        widthMultiple: widthMultiple,\n        heightStep: GRID_BASE_UNIT,\n        heightMultiple: component.meta.height,\n        minWidthMultiple: GRID_MIN_COLUMN_COUNT,\n        minHeightMultiple: GRID_MIN_ROW_UNITS,\n        maxWidthMultiple: availableColumnCount + widthMultiple,\n        onResizeStart: onResizeStart,\n        onResize: onResize,\n        onResizeStop: onResizeStop\n        // disable resize when editing because if state is not synced\n        // with props it will reset the editor text to whatever props is\n        , editMode: isFocused ? false : editMode },\n\n      ___EmotionJSX(\"div\", {\n        ref: dragSourceRef,\n        className: \"dashboard-component dashboard-component-chart-holder\" },\n\n      editMode && isEditing ?\n      this.renderEditMode() :\n      this.renderPreviewMode()))),\n\n\n\n      dropIndicatorProps && ___EmotionJSX(\"div\", dropIndicatorProps))));\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}\nMarkdown.propTypes = propTypes;\nMarkdown.defaultProps = defaultProps;const _default =\n\nMarkdown;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(propTypes, \"propTypes\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/components/gridComponents/Markdown.jsx\");reactHotLoader.register(defaultProps, \"defaultProps\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/components/gridComponents/Markdown.jsx\");reactHotLoader.register(MARKDOWN_PLACE_HOLDER, \"MARKDOWN_PLACE_HOLDER\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/components/gridComponents/Markdown.jsx\");reactHotLoader.register(MARKDOWN_ERROR_MESSAGE, \"MARKDOWN_ERROR_MESSAGE\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/components/gridComponents/Markdown.jsx\");reactHotLoader.register(isSafeMarkup, \"isSafeMarkup\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/components/gridComponents/Markdown.jsx\");reactHotLoader.register(Markdown, \"Markdown\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/components/gridComponents/Markdown.jsx\");reactHotLoader.register(_default, \"default\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/components/gridComponents/Markdown.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":null,"metadata":{},"sourceType":"module"}