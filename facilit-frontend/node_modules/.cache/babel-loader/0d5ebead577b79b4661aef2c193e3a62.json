{"ast":null,"code":"import \"core-js/modules/es.regexp.to-string\";import \"core-js/modules/es.string.search\";import _Object$assign from \"@babel/runtime-corejs3/core-js-stable/object/assign\";import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _forEachInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/for-each\";import _includesInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/includes\";import _sliceInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/slice\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       */\n/* eslint camelcase: 0 */\nimport URI from 'urijs';\nimport { SupersetClient } from '@superset-ui/connection';\nimport { buildQueryContext } from '@superset-ui/query';\nimport { availableDomains } from 'src/utils/hostNamesConfig';\nimport { safeStringify } from 'src/utils/safeStringify';\nimport {\ngetChartBuildQueryRegistry,\ngetChartMetadataRegistry } from\n'@superset-ui/chart';\n\nconst MAX_URL_LENGTH = 8000;\n\nexport function getChartKey(explore) {\n  const slice = _sliceInstanceProperty(explore);\n  return slice ? slice.slice_id : 0;\n}\n\nlet requestCounter = 0;\nexport function getHostName(allowDomainSharding = false) {\n  let currentIndex = 0;\n  if (allowDomainSharding) {\n    currentIndex = requestCounter % availableDomains.length;\n    requestCounter += 1;\n\n    // if domain sharding is enabled, skip main domain for fetching chart API\n    // leave main domain free for other calls like fav star, save change, etc.\n    // to make dashboard be responsive when it's loading large number of charts\n    if (currentIndex === 0) {\n      currentIndex += 1;\n      requestCounter += 1;\n    }\n  }\n  return availableDomains[currentIndex];\n}\n\nexport function getAnnotationJsonUrl(slice_id, form_data, isNative) {\n  if (slice_id === null || slice_id === undefined) {\n    return null;\n  }\n  const uri = URI(window.location.search);\n  const endpoint = isNative ? 'annotation_json' : 'slice_json';\n  return uri.\n  pathname(\"/superset/\" + endpoint + \"/\" + slice_id).\n  search({\n    form_data: safeStringify(form_data, (key, value) =>\n    value === null ? undefined : value) }).\n\n\n  toString();\n}\n\nexport function getURIDirectory(endpointType = 'base') {var _context;\n  // Building the directory part of the URI\n  if (\n  _includesInstanceProperty(_context = ['full', 'json', 'csv', 'query', 'results', 'samples']).call(_context,\n  endpointType))\n\n  {\n    return '/superset/explore_json/';\n  }\n  return '/superset/explore/';\n}\n\nexport function getExploreLongUrl(\nformData,\nendpointType,\nallowOverflow = true,\nextraSearch = {})\n{var _context2;\n  if (!formData.datasource) {\n    return null;\n  }\n\n  const uri = new URI('/');\n  const directory = getURIDirectory(endpointType);\n  const search = uri.search(true);\n  _forEachInstanceProperty(_context2 = _Object$keys(extraSearch)).call(_context2, key => {\n    search[key] = extraSearch[key];\n  });\n  search.form_data = safeStringify(formData);\n  if (endpointType === 'standalone') {\n    search.standalone = 'true';\n  }\n  const url = uri.directory(directory).search(search).toString();\n  if (!allowOverflow && url.length > MAX_URL_LENGTH) {\n    const minimalFormData = {\n      datasource: formData.datasource,\n      viz_type: formData.viz_type };\n\n    return getExploreLongUrl(minimalFormData, endpointType, false, {\n      URL_IS_TOO_LONG_TO_SHARE: null });\n\n  }\n  return url;\n}\n\nexport function getChartDataUri({ path, qs, allowDomainSharding = false }) {var _context3;\n  // The search params from the window.location are carried through,\n  // but can be specified with curUrl (used for unit tests to spoof\n  // the window.location).\n  let uri = new URI({\n    protocol: _sliceInstanceProperty(_context3 = location.protocol).call(_context3, 0, -1),\n    hostname: getHostName(allowDomainSharding),\n    port: location.port ? location.port : '',\n    path });\n\n  if (qs) {\n    uri = uri.search(qs);\n  }\n  return uri;\n}\n\nexport function getExploreUrl({\n  formData,\n  endpointType = 'base',\n  force = false,\n  curUrl = null,\n  requestParams = {},\n  allowDomainSharding = false,\n  method = 'POST' })\n{\n  if (!formData.datasource) {\n    return null;\n  }\n  let uri = getChartDataUri({ path: '/', allowDomainSharding });\n  if (curUrl) {\n    uri = URI(URI(curUrl).search());\n  }\n\n  const directory = getURIDirectory(endpointType);\n\n  // Building the querystring (search) part of the URI\n  const search = uri.search(true);\n  const { slice_id, extra_filters, adhoc_filters, viz_type } = formData;\n  if (slice_id) {\n    const form_data = { slice_id };\n    if (method === 'GET') {\n      form_data.viz_type = viz_type;\n      if (extra_filters && extra_filters.length) {\n        form_data.extra_filters = extra_filters;\n      }\n      if (adhoc_filters && adhoc_filters.length) {\n        form_data.adhoc_filters = adhoc_filters;\n      }\n    }\n    search.form_data = safeStringify(form_data);\n  }\n  if (force) {\n    search.force = 'true';\n  }\n  if (endpointType === 'csv') {\n    search.csv = 'true';\n  }\n  if (endpointType === 'standalone') {\n    search.standalone = 'true';\n  }\n  if (endpointType === 'query') {\n    search.query = 'true';\n  }\n  if (endpointType === 'results') {\n    search.results = 'true';\n  }\n  if (endpointType === 'samples') {\n    search.samples = 'true';\n  }\n  const paramNames = _Object$keys(requestParams);\n  if (paramNames.length) {\n    _forEachInstanceProperty(paramNames).call(paramNames, name => {\n      if (requestParams.hasOwnProperty(name)) {\n        search[name] = requestParams[name];\n      }\n    });\n  }\n  return uri.search(search).directory(directory).toString();\n}\n\nexport const shouldUseLegacyApi = formData => {\n  const { useLegacyApi } = getChartMetadataRegistry().get(formData.viz_type);\n  return useLegacyApi || false;\n};\n\nexport const buildV1ChartDataPayload = ({\n  formData,\n  force,\n  resultFormat,\n  resultType }) =>\n{var _getChartBuildQueryRe;\n  const buildQuery = (_getChartBuildQueryRe =\n  getChartBuildQueryRegistry().get(formData.viz_type)) != null ? _getChartBuildQueryRe :\n  (buildQueryformData) =>\n  buildQueryContext(buildQueryformData, baseQueryObject => [_Object$assign({},\n\n  baseQueryObject)]);\n\n\n  return buildQuery(_Object$assign({},\n  formData, {\n    force,\n    result_format: resultFormat,\n    result_type: resultType }));\n\n};\n\nexport const getLegacyEndpointType = ({ resultType, resultFormat }) => {\n  return resultFormat === 'csv' ? resultFormat : resultType;\n};\n\nexport function postForm(url, payload, target = '_blank') {\n  if (!url) {\n    return;\n  }\n\n  const hiddenForm = document.createElement('form');\n  hiddenForm.action = url;\n  hiddenForm.method = 'POST';\n  hiddenForm.target = target;\n  const token = document.createElement('input');\n  token.type = 'hidden';\n  token.name = 'csrf_token';\n  token.value = (document.getElementById('csrf_token') || {}).value;\n  hiddenForm.appendChild(token);\n  const data = document.createElement('input');\n  data.type = 'hidden';\n  data.name = 'form_data';\n  data.value = safeStringify(payload);\n  hiddenForm.appendChild(data);\n\n  document.body.appendChild(hiddenForm);\n  hiddenForm.submit();\n  document.body.removeChild(hiddenForm);\n}\n\nexport const exportChart = ({\n  formData,\n  resultFormat = 'json',\n  resultType = 'full',\n  force = false }) =>\n{\n  let url;\n  let payload;\n  if (shouldUseLegacyApi(formData)) {\n    const endpointType = getLegacyEndpointType({ resultFormat, resultType });\n    url = getExploreUrl({\n      formData,\n      endpointType,\n      allowDomainSharding: false });\n\n    payload = formData;\n  } else {\n    url = '/api/v1/chart/data';\n    payload = buildV1ChartDataPayload({\n      formData,\n      force,\n      resultFormat,\n      resultType });\n\n  }\n  postForm(url, payload);\n};\n\nexport const exploreChart = formData => {\n  const url = getExploreUrl({\n    formData,\n    endpointType: 'base',\n    allowDomainSharding: false });\n\n  postForm(url, formData);\n};;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(MAX_URL_LENGTH, \"MAX_URL_LENGTH\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(getChartKey, \"getChartKey\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(requestCounter, \"requestCounter\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(getHostName, \"getHostName\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(getAnnotationJsonUrl, \"getAnnotationJsonUrl\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(getURIDirectory, \"getURIDirectory\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(getExploreLongUrl, \"getExploreLongUrl\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(getChartDataUri, \"getChartDataUri\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(getExploreUrl, \"getExploreUrl\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(shouldUseLegacyApi, \"shouldUseLegacyApi\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(buildV1ChartDataPayload, \"buildV1ChartDataPayload\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(getLegacyEndpointType, \"getLegacyEndpointType\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(postForm, \"postForm\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(exportChart, \"exportChart\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");reactHotLoader.register(exploreChart, \"exploreChart\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/exploreUtils.js"],"names":["URI","SupersetClient","buildQueryContext","availableDomains","safeStringify","getChartBuildQueryRegistry","getChartMetadataRegistry","MAX_URL_LENGTH","getChartKey","explore","slice","slice_id","requestCounter","getHostName","allowDomainSharding","currentIndex","length","getAnnotationJsonUrl","form_data","isNative","undefined","uri","window","location","search","endpoint","pathname","key","value","toString","getURIDirectory","endpointType","getExploreLongUrl","formData","allowOverflow","extraSearch","datasource","directory","standalone","url","minimalFormData","viz_type","URL_IS_TOO_LONG_TO_SHARE","getChartDataUri","path","qs","protocol","hostname","port","getExploreUrl","force","curUrl","requestParams","method","extra_filters","adhoc_filters","csv","query","results","samples","paramNames","name","hasOwnProperty","shouldUseLegacyApi","useLegacyApi","get","buildV1ChartDataPayload","resultFormat","resultType","buildQuery","buildQueryformData","baseQueryObject","result_format","result_type","getLegacyEndpointType","postForm","payload","target","hiddenForm","document","createElement","action","token","type","getElementById","appendChild","data","body","submit","removeChild","exportChart","exploreChart"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n/* eslint camelcase: 0 */\nimport URI from 'urijs';\nimport { SupersetClient } from '@superset-ui/connection';\nimport { buildQueryContext } from '@superset-ui/query';\nimport { availableDomains } from 'src/utils/hostNamesConfig';\nimport { safeStringify } from 'src/utils/safeStringify';\nimport {\n  getChartBuildQueryRegistry,\n  getChartMetadataRegistry,\n} from '@superset-ui/chart';\n\nconst MAX_URL_LENGTH = 8000;\n\nexport function getChartKey(explore) {\n  const slice = explore.slice;\n  return slice ? slice.slice_id : 0;\n}\n\nlet requestCounter = 0;\nexport function getHostName(allowDomainSharding = false) {\n  let currentIndex = 0;\n  if (allowDomainSharding) {\n    currentIndex = requestCounter % availableDomains.length;\n    requestCounter += 1;\n\n    // if domain sharding is enabled, skip main domain for fetching chart API\n    // leave main domain free for other calls like fav star, save change, etc.\n    // to make dashboard be responsive when it's loading large number of charts\n    if (currentIndex === 0) {\n      currentIndex += 1;\n      requestCounter += 1;\n    }\n  }\n  return availableDomains[currentIndex];\n}\n\nexport function getAnnotationJsonUrl(slice_id, form_data, isNative) {\n  if (slice_id === null || slice_id === undefined) {\n    return null;\n  }\n  const uri = URI(window.location.search);\n  const endpoint = isNative ? 'annotation_json' : 'slice_json';\n  return uri\n    .pathname(`/superset/${endpoint}/${slice_id}`)\n    .search({\n      form_data: safeStringify(form_data, (key, value) =>\n        value === null ? undefined : value,\n      ),\n    })\n    .toString();\n}\n\nexport function getURIDirectory(endpointType = 'base') {\n  // Building the directory part of the URI\n  if (\n    ['full', 'json', 'csv', 'query', 'results', 'samples'].includes(\n      endpointType,\n    )\n  ) {\n    return '/superset/explore_json/';\n  }\n  return '/superset/explore/';\n}\n\nexport function getExploreLongUrl(\n  formData,\n  endpointType,\n  allowOverflow = true,\n  extraSearch = {},\n) {\n  if (!formData.datasource) {\n    return null;\n  }\n\n  const uri = new URI('/');\n  const directory = getURIDirectory(endpointType);\n  const search = uri.search(true);\n  Object.keys(extraSearch).forEach(key => {\n    search[key] = extraSearch[key];\n  });\n  search.form_data = safeStringify(formData);\n  if (endpointType === 'standalone') {\n    search.standalone = 'true';\n  }\n  const url = uri.directory(directory).search(search).toString();\n  if (!allowOverflow && url.length > MAX_URL_LENGTH) {\n    const minimalFormData = {\n      datasource: formData.datasource,\n      viz_type: formData.viz_type,\n    };\n    return getExploreLongUrl(minimalFormData, endpointType, false, {\n      URL_IS_TOO_LONG_TO_SHARE: null,\n    });\n  }\n  return url;\n}\n\nexport function getChartDataUri({ path, qs, allowDomainSharding = false }) {\n  // The search params from the window.location are carried through,\n  // but can be specified with curUrl (used for unit tests to spoof\n  // the window.location).\n  let uri = new URI({\n    protocol: location.protocol.slice(0, -1),\n    hostname: getHostName(allowDomainSharding),\n    port: location.port ? location.port : '',\n    path,\n  });\n  if (qs) {\n    uri = uri.search(qs);\n  }\n  return uri;\n}\n\nexport function getExploreUrl({\n  formData,\n  endpointType = 'base',\n  force = false,\n  curUrl = null,\n  requestParams = {},\n  allowDomainSharding = false,\n  method = 'POST',\n}) {\n  if (!formData.datasource) {\n    return null;\n  }\n  let uri = getChartDataUri({ path: '/', allowDomainSharding });\n  if (curUrl) {\n    uri = URI(URI(curUrl).search());\n  }\n\n  const directory = getURIDirectory(endpointType);\n\n  // Building the querystring (search) part of the URI\n  const search = uri.search(true);\n  const { slice_id, extra_filters, adhoc_filters, viz_type } = formData;\n  if (slice_id) {\n    const form_data = { slice_id };\n    if (method === 'GET') {\n      form_data.viz_type = viz_type;\n      if (extra_filters && extra_filters.length) {\n        form_data.extra_filters = extra_filters;\n      }\n      if (adhoc_filters && adhoc_filters.length) {\n        form_data.adhoc_filters = adhoc_filters;\n      }\n    }\n    search.form_data = safeStringify(form_data);\n  }\n  if (force) {\n    search.force = 'true';\n  }\n  if (endpointType === 'csv') {\n    search.csv = 'true';\n  }\n  if (endpointType === 'standalone') {\n    search.standalone = 'true';\n  }\n  if (endpointType === 'query') {\n    search.query = 'true';\n  }\n  if (endpointType === 'results') {\n    search.results = 'true';\n  }\n  if (endpointType === 'samples') {\n    search.samples = 'true';\n  }\n  const paramNames = Object.keys(requestParams);\n  if (paramNames.length) {\n    paramNames.forEach(name => {\n      if (requestParams.hasOwnProperty(name)) {\n        search[name] = requestParams[name];\n      }\n    });\n  }\n  return uri.search(search).directory(directory).toString();\n}\n\nexport const shouldUseLegacyApi = formData => {\n  const { useLegacyApi } = getChartMetadataRegistry().get(formData.viz_type);\n  return useLegacyApi || false;\n};\n\nexport const buildV1ChartDataPayload = ({\n  formData,\n  force,\n  resultFormat,\n  resultType,\n}) => {\n  const buildQuery =\n    getChartBuildQueryRegistry().get(formData.viz_type) ??\n    (buildQueryformData =>\n      buildQueryContext(buildQueryformData, baseQueryObject => [\n        {\n          ...baseQueryObject,\n        },\n      ]));\n  return buildQuery({\n    ...formData,\n    force,\n    result_format: resultFormat,\n    result_type: resultType,\n  });\n};\n\nexport const getLegacyEndpointType = ({ resultType, resultFormat }) => {\n  return resultFormat === 'csv' ? resultFormat : resultType;\n};\n\nexport function postForm(url, payload, target = '_blank') {\n  if (!url) {\n    return;\n  }\n\n  const hiddenForm = document.createElement('form');\n  hiddenForm.action = url;\n  hiddenForm.method = 'POST';\n  hiddenForm.target = target;\n  const token = document.createElement('input');\n  token.type = 'hidden';\n  token.name = 'csrf_token';\n  token.value = (document.getElementById('csrf_token') || {}).value;\n  hiddenForm.appendChild(token);\n  const data = document.createElement('input');\n  data.type = 'hidden';\n  data.name = 'form_data';\n  data.value = safeStringify(payload);\n  hiddenForm.appendChild(data);\n\n  document.body.appendChild(hiddenForm);\n  hiddenForm.submit();\n  document.body.removeChild(hiddenForm);\n}\n\nexport const exportChart = ({\n  formData,\n  resultFormat = 'json',\n  resultType = 'full',\n  force = false,\n}) => {\n  let url;\n  let payload;\n  if (shouldUseLegacyApi(formData)) {\n    const endpointType = getLegacyEndpointType({ resultFormat, resultType });\n    url = getExploreUrl({\n      formData,\n      endpointType,\n      allowDomainSharding: false,\n    });\n    payload = formData;\n  } else {\n    url = '/api/v1/chart/data';\n    payload = buildV1ChartDataPayload({\n      formData,\n      force,\n      resultFormat,\n      resultType,\n    });\n  }\n  postForm(url, payload);\n};\n\nexport const exploreChart = formData => {\n  const url = getExploreUrl({\n    formData,\n    endpointType: 'base',\n    allowDomainSharding: false,\n  });\n  postForm(url, formData);\n};\n"]},"metadata":{},"sourceType":"module"}