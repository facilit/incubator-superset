{"ast":null,"code":"import \"core-js/modules/web.dom-collections.iterator\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _includesInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/includes\";import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _Array$isArray from \"@babel/runtime-corejs3/core-js-stable/array/is-array\";import _isEmpty from \"lodash/isEmpty\";import _isEqual from \"lodash/isEqual\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { Table, Tr, Td, Thead, Th } from 'reactable-arc';\n\nimport { getChartControlPanelRegistry } from '@superset-ui/chart';\nimport getControlsForVizType from 'src/utils/getControlsForVizType';\nimport { t } from '@superset-ui/translation';\nimport TooltipWrapper from './TooltipWrapper';\nimport ModalTrigger from './ModalTrigger';\nimport { safeStringify } from '../utils/safeStringify';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst propTypes = {\n  origFormData: PropTypes.object.isRequired,\n  currentFormData: PropTypes.object.isRequired };\n\n\nfunction alterForComparison(value) {\n  // Considering `[]`, `{}`, `null` and `undefined` as identical\n  // for this purpose\n  if (value === undefined || value === null || value === '') {\n    return null;\n  } else if (typeof value === 'object') {\n    if (_Array$isArray(value) && value.length === 0) {\n      return null;\n    }\n    const keys = _Object$keys(value);\n    if (keys && keys.length === 0) {\n      return null;\n    }\n  }\n  return value;\n}\n\nexport default class AlteredSliceTag extends React.Component {\n  constructor(props) {\n    super(props);\n    const diffs = this.getDiffs(props);\n\n    const controlsMap = getControlsForVizType(this.props.origFormData.viz_type);\n\n    this.state = { diffs, hasDiffs: !_isEmpty(diffs), controlsMap };\n  }\n\n  UNSAFE_componentWillReceiveProps(newProps) {\n    // Update differences if need be\n    if (_isEqual(this.props, newProps)) {\n      return;\n    }\n    const diffs = this.getDiffs(newProps);\n    this.setState({ diffs, hasDiffs: !_isEmpty(diffs) });\n  }\n\n  getDiffs(props) {\n    // Returns all properties that differ in the\n    // current form data and the saved form data\n    const ofd = props.origFormData;\n    const cfd = props.currentFormData;\n\n    const fdKeys = _Object$keys(cfd);\n    const diffs = {};\n    for (const fdKey of fdKeys) {var _context;\n      // Ignore values that are undefined/nonexisting in either\n      if (!ofd[fdKey] && !cfd[fdKey]) {\n        continue;\n      }\n      // Ignore obsolete legacy filters\n      if (_includesInstanceProperty(_context = ['filters', 'having', 'having_filters', 'where']).call(_context, fdKey)) {\n        continue;\n      }\n      if (!this.isEqualish(ofd[fdKey], cfd[fdKey])) {\n        diffs[fdKey] = { before: ofd[fdKey], after: cfd[fdKey] };\n      }\n    }\n    return diffs;\n  }\n\n  isEqualish(val1, val2) {\n    return _isEqual(alterForComparison(val1), alterForComparison(val2));\n  }\n\n  formatValue(value, key) {\n    // Format display value based on the control type\n    // or the value type\n    if (value === undefined) {\n      return 'N/A';\n    } else if (value === null) {\n      return 'null';\n    } else if (\n    this.state.controlsMap[key] &&\n    this.state.controlsMap[key].type === 'AdhocFilterControl')\n    {\n      if (!value.length) {\n        return '[]';\n      }\n      return _mapInstanceProperty(value).call(value,\n      v => {\n        const filterVal =\n        v.comparator && v.comparator.constructor === Array ? \"[\" +\n        v.comparator.join(', ') + \"]\" :\n        v.comparator;\n        return v.subject + \" \" + v.operator + \" \" + filterVal;\n      }).\n      join(', ');\n    } else if (\n    this.state.controlsMap[key] &&\n    this.state.controlsMap[key].type === 'BoundsControl')\n    {\n      return \"Min: \" + value[0] + \", Max: \" + value[1];\n    } else if (\n    this.state.controlsMap[key] &&\n    this.state.controlsMap[key].type === 'CollectionControl')\n    {\n      return _mapInstanceProperty(value).call(value, v => safeStringify(v)).join(', ');\n    } else if (typeof value === 'boolean') {\n      return value ? 'true' : 'false';\n    } else if (value.constructor === Array) {\n      return value.length ? value.join(', ') : '[]';\n    } else if (typeof value === 'string' || typeof value === 'number') {\n      return value;\n    }\n    return safeStringify(value);\n  }\n\n  renderRows() {\n    const diffs = this.state.diffs;\n    const rows = [];\n    for (const key in diffs) {\n      rows.push(\n      ___EmotionJSX(Tr, { key: key },\n      ___EmotionJSX(Td, {\n        column: \"control\",\n        data:\n        this.state.controlsMap[key] &&\n        this.state.controlsMap[key].label ||\n        key }),\n\n\n      ___EmotionJSX(Td, { column: \"before\" }, this.formatValue(diffs[key].before, key)),\n      ___EmotionJSX(Td, { column: \"after\" }, this.formatValue(diffs[key].after, key))));\n\n\n    }\n    return rows;\n  }\n\n  renderModalBody() {\n    return (\n      ___EmotionJSX(Table, { className: \"table\", sortable: true },\n      ___EmotionJSX(Thead, null,\n      ___EmotionJSX(Th, { column: \"control\" }, \"Control\"),\n      ___EmotionJSX(Th, { column: \"before\" }, \"Before\"),\n      ___EmotionJSX(Th, { column: \"after\" }, \"After\")),\n\n      this.renderRows()));\n\n\n  }\n\n  renderTriggerNode() {\n    return (\n      ___EmotionJSX(TooltipWrapper, { label: \"difference\", tooltip: t('Click to see difference') },\n      ___EmotionJSX(\"span\", {\n        className: \"label label-warning m-l-5\",\n        style: { fontSize: '12px' } },\n\n      t('Altered'))));\n\n\n\n  }\n\n  render() {\n    // Return nothing if there are no differences\n    if (!this.state.hasDiffs) {\n      return null;\n    }\n    // Render the label-warning 'Altered' tag which the user may\n    // click to open a modal containing a table summarizing the\n    // differences in the slice\n    return (\n      ___EmotionJSX(ModalTrigger, {\n        animation: true,\n        triggerNode: this.renderTriggerNode(),\n        modalTitle: t('Chart changes'),\n        bsSize: \"large\",\n        modalBody: this.renderModalBody() }));\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}\nAlteredSliceTag.propTypes = propTypes;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(propTypes, \"propTypes\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/components/AlteredSliceTag.jsx\");reactHotLoader.register(alterForComparison, \"alterForComparison\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/components/AlteredSliceTag.jsx\");reactHotLoader.register(AlteredSliceTag, \"AlteredSliceTag\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/components/AlteredSliceTag.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/tiago/git-facilit/incubator-superset/superset-frontend/src/components/AlteredSliceTag.jsx"],"names":["React","PropTypes","Table","Tr","Td","Thead","Th","getChartControlPanelRegistry","getControlsForVizType","t","TooltipWrapper","ModalTrigger","safeStringify","propTypes","origFormData","object","isRequired","currentFormData","alterForComparison","value","undefined","length","keys","AlteredSliceTag","Component","constructor","props","diffs","getDiffs","controlsMap","viz_type","state","hasDiffs","UNSAFE_componentWillReceiveProps","newProps","setState","ofd","cfd","fdKeys","fdKey","isEqualish","before","after","val1","val2","formatValue","key","type","v","filterVal","comparator","Array","join","subject","operator","renderRows","rows","push","label","renderModalBody","renderTriggerNode","fontSize","render"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { Table, Tr, Td, Thead, Th } from 'reactable-arc';\nimport { isEqual, isEmpty } from 'lodash';\nimport { getChartControlPanelRegistry } from '@superset-ui/chart';\nimport getControlsForVizType from 'src/utils/getControlsForVizType';\nimport { t } from '@superset-ui/translation';\nimport TooltipWrapper from './TooltipWrapper';\nimport ModalTrigger from './ModalTrigger';\nimport { safeStringify } from '../utils/safeStringify';\n\nconst propTypes = {\n  origFormData: PropTypes.object.isRequired,\n  currentFormData: PropTypes.object.isRequired,\n};\n\nfunction alterForComparison(value) {\n  // Considering `[]`, `{}`, `null` and `undefined` as identical\n  // for this purpose\n  if (value === undefined || value === null || value === '') {\n    return null;\n  } else if (typeof value === 'object') {\n    if (Array.isArray(value) && value.length === 0) {\n      return null;\n    }\n    const keys = Object.keys(value);\n    if (keys && keys.length === 0) {\n      return null;\n    }\n  }\n  return value;\n}\n\nexport default class AlteredSliceTag extends React.Component {\n  constructor(props) {\n    super(props);\n    const diffs = this.getDiffs(props);\n\n    const controlsMap = getControlsForVizType(this.props.origFormData.viz_type);\n\n    this.state = { diffs, hasDiffs: !isEmpty(diffs), controlsMap };\n  }\n\n  UNSAFE_componentWillReceiveProps(newProps) {\n    // Update differences if need be\n    if (isEqual(this.props, newProps)) {\n      return;\n    }\n    const diffs = this.getDiffs(newProps);\n    this.setState({ diffs, hasDiffs: !isEmpty(diffs) });\n  }\n\n  getDiffs(props) {\n    // Returns all properties that differ in the\n    // current form data and the saved form data\n    const ofd = props.origFormData;\n    const cfd = props.currentFormData;\n\n    const fdKeys = Object.keys(cfd);\n    const diffs = {};\n    for (const fdKey of fdKeys) {\n      // Ignore values that are undefined/nonexisting in either\n      if (!ofd[fdKey] && !cfd[fdKey]) {\n        continue;\n      }\n      // Ignore obsolete legacy filters\n      if (['filters', 'having', 'having_filters', 'where'].includes(fdKey)) {\n        continue;\n      }\n      if (!this.isEqualish(ofd[fdKey], cfd[fdKey])) {\n        diffs[fdKey] = { before: ofd[fdKey], after: cfd[fdKey] };\n      }\n    }\n    return diffs;\n  }\n\n  isEqualish(val1, val2) {\n    return isEqual(alterForComparison(val1), alterForComparison(val2));\n  }\n\n  formatValue(value, key) {\n    // Format display value based on the control type\n    // or the value type\n    if (value === undefined) {\n      return 'N/A';\n    } else if (value === null) {\n      return 'null';\n    } else if (\n      this.state.controlsMap[key] &&\n      this.state.controlsMap[key].type === 'AdhocFilterControl'\n    ) {\n      if (!value.length) {\n        return '[]';\n      }\n      return value\n        .map(v => {\n          const filterVal =\n            v.comparator && v.comparator.constructor === Array\n              ? `[${v.comparator.join(', ')}]`\n              : v.comparator;\n          return `${v.subject} ${v.operator} ${filterVal}`;\n        })\n        .join(', ');\n    } else if (\n      this.state.controlsMap[key] &&\n      this.state.controlsMap[key].type === 'BoundsControl'\n    ) {\n      return `Min: ${value[0]}, Max: ${value[1]}`;\n    } else if (\n      this.state.controlsMap[key] &&\n      this.state.controlsMap[key].type === 'CollectionControl'\n    ) {\n      return value.map(v => safeStringify(v)).join(', ');\n    } else if (typeof value === 'boolean') {\n      return value ? 'true' : 'false';\n    } else if (value.constructor === Array) {\n      return value.length ? value.join(', ') : '[]';\n    } else if (typeof value === 'string' || typeof value === 'number') {\n      return value;\n    }\n    return safeStringify(value);\n  }\n\n  renderRows() {\n    const diffs = this.state.diffs;\n    const rows = [];\n    for (const key in diffs) {\n      rows.push(\n        <Tr key={key}>\n          <Td\n            column=\"control\"\n            data={\n              (this.state.controlsMap[key] &&\n                this.state.controlsMap[key].label) ||\n              key\n            }\n          />\n          <Td column=\"before\">{this.formatValue(diffs[key].before, key)}</Td>\n          <Td column=\"after\">{this.formatValue(diffs[key].after, key)}</Td>\n        </Tr>,\n      );\n    }\n    return rows;\n  }\n\n  renderModalBody() {\n    return (\n      <Table className=\"table\" sortable>\n        <Thead>\n          <Th column=\"control\">Control</Th>\n          <Th column=\"before\">Before</Th>\n          <Th column=\"after\">After</Th>\n        </Thead>\n        {this.renderRows()}\n      </Table>\n    );\n  }\n\n  renderTriggerNode() {\n    return (\n      <TooltipWrapper label=\"difference\" tooltip={t('Click to see difference')}>\n        <span\n          className=\"label label-warning m-l-5\"\n          style={{ fontSize: '12px' }}\n        >\n          {t('Altered')}\n        </span>\n      </TooltipWrapper>\n    );\n  }\n\n  render() {\n    // Return nothing if there are no differences\n    if (!this.state.hasDiffs) {\n      return null;\n    }\n    // Render the label-warning 'Altered' tag which the user may\n    // click to open a modal containing a table summarizing the\n    // differences in the slice\n    return (\n      <ModalTrigger\n        animation\n        triggerNode={this.renderTriggerNode()}\n        modalTitle={t('Chart changes')}\n        bsSize=\"large\"\n        modalBody={this.renderModalBody()}\n      />\n    );\n  }\n}\n\nAlteredSliceTag.propTypes = propTypes;\n"]},"metadata":{},"sourceType":"module"}