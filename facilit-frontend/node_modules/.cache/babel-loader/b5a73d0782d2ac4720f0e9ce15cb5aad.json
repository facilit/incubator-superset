{"ast":null,"code":"import \"core-js/modules/web.dom-collections.iterator\";import _Symbol$toPrimitive from \"@babel/runtime-corejs3/core-js-stable/symbol/to-primitive\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _objectWithoutPropertiesLoose from \"@babel/runtime-corejs3/helpers/objectWithoutPropertiesLoose\";import _Object$entries from \"@babel/runtime-corejs3/core-js-stable/object/entries\";import _includesInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/includes\";import _sliceInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/slice\";import _concatInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/concat\";import _Object$assign from \"@babel/runtime-corejs3/core-js-stable/object/assign\";import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _reduceInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/reduce\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();function _toPropertyKey(arg) {var key = _toPrimitive(arg, \"string\");return typeof key === \"symbol\" ? key : String(key);}function _toPrimitive(input, hint) {if (typeof input !== \"object\" || input === null) return input;var prim = input[_Symbol$toPrimitive];if (prim !== undefined) {var res = prim.call(input, hint || \"default\");if (typeof res !== \"object\") return res;throw new TypeError(\"@@toPrimitive must return a primitive value.\");}return (hint === \"string\" ? String : Number)(input);}var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     */\n/* eslint-disable camelcase */\nimport {\nADD_FILTER,\nREMOVE_FILTER,\nCHANGE_FILTER,\nUPDATE_DIRECT_PATH_TO_FILTER,\nUPDATE_LAYOUT_COMPONENTS,\nUPDATE_DASHBOARD_FILTERS_SCOPE } from\n'../actions/dashboardFilters';\nimport { TIME_RANGE } from '../../visualizations/FilterBox/FilterBox';\nimport { DASHBOARD_ROOT_ID } from '../util/constants';\nimport getFilterConfigsFromFormdata from '../util/getFilterConfigsFromFormdata';\nimport { buildFilterColorMap } from '../util/dashboardFiltersColorMap';\nimport { buildActiveFilters } from '../util/activeDashboardFilters';\nimport { getChartIdAndColumnFromFilterKey } from '../util/getDashboardFilterKey';\n\nexport const DASHBOARD_FILTER_SCOPE_GLOBAL = {\n  scope: [DASHBOARD_ROOT_ID],\n  immune: [] };\n\n\nexport const dashboardFilter = {\n  chartId: null,\n  componentId: null,\n  filterName: null,\n  datasourceId: null,\n  directPathToFilter: [],\n  isDateFilter: false,\n  isInstantFilter: true,\n  columns: {},\n  labels: {},\n  scopes: {} };\n\n\nconst CHANGE_FILTER_VALUE_ACTIONS = [ADD_FILTER, REMOVE_FILTER, CHANGE_FILTER];\n\nexport default function dashboardFiltersReducer(dashboardFilters = {}, action) {\n  const actionHandlers = {\n    [ADD_FILTER]() {var _context, _context2, _context3, _context4;\n      const { chartId, component, form_data } = action;\n      const { columns, labels } = getFilterConfigsFromFormdata(form_data);\n      const scopes = _reduceInstanceProperty(_context = _Object$keys(columns)).call(_context,\n      (map, column) => _Object$assign({},\n      map, {\n        [column]: DASHBOARD_FILTER_SCOPE_GLOBAL }),\n\n      {});\n\n      const directPathToFilter = component ?\n      _concatInstanceProperty(_context2 = _sliceInstanceProperty(_context3 = component.parents || []).call(_context3)).call(_context2, component.id) :\n      [];\n\n      const newFilter = _Object$assign({},\n      dashboardFilter, {\n        chartId,\n        componentId: component.id,\n        datasourceId: form_data.datasource,\n        filterName: component.meta.sliceName,\n        directPathToFilter,\n        columns,\n        labels,\n        scopes,\n        isInstantFilter: !!form_data.instant_filtering,\n        isDateFilter: _includesInstanceProperty(_context4 = _Object$keys(columns)).call(_context4, TIME_RANGE) });\n\n\n      return newFilter;\n    },\n\n    [CHANGE_FILTER](state) {var _context5;\n      const { newSelectedValues, merge } = action;\n      const updatedColumns = _reduceInstanceProperty(_context5 = _Object$keys(newSelectedValues)).call(_context5,\n      (columns, name) => {\n        // override existed column value, or add new column name\n        if (!merge || !(name in columns)) {\n          return _Object$assign({},\n          columns, {\n            [name]: newSelectedValues[name] });\n\n        }\n\n        return _Object$assign({},\n        columns, {\n          [name]: [...columns[name], ...newSelectedValues[name]] });\n\n      }, _Object$assign({},\n      state.columns));\n\n\n      return _Object$assign({},\n      state, {\n        columns: updatedColumns });\n\n    },\n\n    [UPDATE_DIRECT_PATH_TO_FILTER](state) {\n      const { path } = action;\n      return _Object$assign({},\n      state, {\n        directPathToFilter: path });\n\n    } };\n\n\n  if (action.type === UPDATE_LAYOUT_COMPONENTS) {\n    buildActiveFilters({\n      dashboardFilters,\n      components: action.components });\n\n    return dashboardFilters;\n  } else if (action.type === UPDATE_DASHBOARD_FILTERS_SCOPE) {var _context6;\n    const allDashboardFiltersScope = action.scopes;\n    // update filter scope for each filter field\n    const updatedFilters = _reduceInstanceProperty(_context6 = _Object$entries(allDashboardFiltersScope)).call(_context6,\n    (map, entry) => {\n      const [filterKey, { scope, immune }] = entry;\n      const { chartId, column } = getChartIdAndColumnFromFilterKey(filterKey);\n      const scopes = _Object$assign({},\n      map[chartId].scopes, {\n        [column]: {\n          scope,\n          immune } });\n\n\n      return _Object$assign({},\n      map, {\n        [chartId]: _Object$assign({},\n        map[chartId], {\n          scopes }) });\n\n\n    },\n    dashboardFilters);\n\n\n    buildActiveFilters({ dashboardFilters: updatedFilters });\n    return updatedFilters;\n  } else if (action.type === REMOVE_FILTER) {var _context7;\n    const { chartId } = action;\n    const updatedFilters = _objectWithoutPropertiesLoose(dashboardFilters, _mapInstanceProperty(_context7 = [chartId]).call(_context7, _toPropertyKey));\n    buildActiveFilters({ dashboardFilters: updatedFilters });\n    buildFilterColorMap(updatedFilters);\n\n    return updatedFilters;\n  } else if (action.type in actionHandlers) {\n    const updatedFilters = _Object$assign({},\n    dashboardFilters, {\n      [action.chartId]: actionHandlers[action.type](\n      dashboardFilters[action.chartId]) });\n\n\n\n    if (_includesInstanceProperty(CHANGE_FILTER_VALUE_ACTIONS).call(CHANGE_FILTER_VALUE_ACTIONS, action.type)) {\n      buildActiveFilters({ dashboardFilters: updatedFilters });\n      buildFilterColorMap(updatedFilters);\n    }\n\n    return updatedFilters;\n  }\n\n  return dashboardFilters;\n};(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(DASHBOARD_FILTER_SCOPE_GLOBAL, \"DASHBOARD_FILTER_SCOPE_GLOBAL\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/reducers/dashboardFilters.js\");reactHotLoader.register(dashboardFilter, \"dashboardFilter\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/reducers/dashboardFilters.js\");reactHotLoader.register(CHANGE_FILTER_VALUE_ACTIONS, \"CHANGE_FILTER_VALUE_ACTIONS\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/reducers/dashboardFilters.js\");reactHotLoader.register(dashboardFiltersReducer, \"dashboardFiltersReducer\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/reducers/dashboardFilters.js\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/tiago/git-facilit/incubator-superset/superset-frontend/src/dashboard/reducers/dashboardFilters.js"],"names":["ADD_FILTER","REMOVE_FILTER","CHANGE_FILTER","UPDATE_DIRECT_PATH_TO_FILTER","UPDATE_LAYOUT_COMPONENTS","UPDATE_DASHBOARD_FILTERS_SCOPE","TIME_RANGE","DASHBOARD_ROOT_ID","getFilterConfigsFromFormdata","buildFilterColorMap","buildActiveFilters","getChartIdAndColumnFromFilterKey","DASHBOARD_FILTER_SCOPE_GLOBAL","scope","immune","dashboardFilter","chartId","componentId","filterName","datasourceId","directPathToFilter","isDateFilter","isInstantFilter","columns","labels","scopes","CHANGE_FILTER_VALUE_ACTIONS","dashboardFiltersReducer","dashboardFilters","action","actionHandlers","component","form_data","map","column","parents","id","newFilter","datasource","meta","sliceName","instant_filtering","state","newSelectedValues","merge","updatedColumns","name","path","type","components","allDashboardFiltersScope","updatedFilters","entry","filterKey"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n/* eslint-disable camelcase */\nimport {\n  ADD_FILTER,\n  REMOVE_FILTER,\n  CHANGE_FILTER,\n  UPDATE_DIRECT_PATH_TO_FILTER,\n  UPDATE_LAYOUT_COMPONENTS,\n  UPDATE_DASHBOARD_FILTERS_SCOPE,\n} from '../actions/dashboardFilters';\nimport { TIME_RANGE } from '../../visualizations/FilterBox/FilterBox';\nimport { DASHBOARD_ROOT_ID } from '../util/constants';\nimport getFilterConfigsFromFormdata from '../util/getFilterConfigsFromFormdata';\nimport { buildFilterColorMap } from '../util/dashboardFiltersColorMap';\nimport { buildActiveFilters } from '../util/activeDashboardFilters';\nimport { getChartIdAndColumnFromFilterKey } from '../util/getDashboardFilterKey';\n\nexport const DASHBOARD_FILTER_SCOPE_GLOBAL = {\n  scope: [DASHBOARD_ROOT_ID],\n  immune: [],\n};\n\nexport const dashboardFilter = {\n  chartId: null,\n  componentId: null,\n  filterName: null,\n  datasourceId: null,\n  directPathToFilter: [],\n  isDateFilter: false,\n  isInstantFilter: true,\n  columns: {},\n  labels: {},\n  scopes: {},\n};\n\nconst CHANGE_FILTER_VALUE_ACTIONS = [ADD_FILTER, REMOVE_FILTER, CHANGE_FILTER];\n\nexport default function dashboardFiltersReducer(dashboardFilters = {}, action) {\n  const actionHandlers = {\n    [ADD_FILTER]() {\n      const { chartId, component, form_data } = action;\n      const { columns, labels } = getFilterConfigsFromFormdata(form_data);\n      const scopes = Object.keys(columns).reduce(\n        (map, column) => ({\n          ...map,\n          [column]: DASHBOARD_FILTER_SCOPE_GLOBAL,\n        }),\n        {},\n      );\n      const directPathToFilter = component\n        ? (component.parents || []).slice().concat(component.id)\n        : [];\n\n      const newFilter = {\n        ...dashboardFilter,\n        chartId,\n        componentId: component.id,\n        datasourceId: form_data.datasource,\n        filterName: component.meta.sliceName,\n        directPathToFilter,\n        columns,\n        labels,\n        scopes,\n        isInstantFilter: !!form_data.instant_filtering,\n        isDateFilter: Object.keys(columns).includes(TIME_RANGE),\n      };\n\n      return newFilter;\n    },\n\n    [CHANGE_FILTER](state) {\n      const { newSelectedValues, merge } = action;\n      const updatedColumns = Object.keys(newSelectedValues).reduce(\n        (columns, name) => {\n          // override existed column value, or add new column name\n          if (!merge || !(name in columns)) {\n            return {\n              ...columns,\n              [name]: newSelectedValues[name],\n            };\n          }\n\n          return {\n            ...columns,\n            [name]: [...columns[name], ...newSelectedValues[name]],\n          };\n        },\n        { ...state.columns },\n      );\n\n      return {\n        ...state,\n        columns: updatedColumns,\n      };\n    },\n\n    [UPDATE_DIRECT_PATH_TO_FILTER](state) {\n      const { path } = action;\n      return {\n        ...state,\n        directPathToFilter: path,\n      };\n    },\n  };\n\n  if (action.type === UPDATE_LAYOUT_COMPONENTS) {\n    buildActiveFilters({\n      dashboardFilters,\n      components: action.components,\n    });\n    return dashboardFilters;\n  } else if (action.type === UPDATE_DASHBOARD_FILTERS_SCOPE) {\n    const allDashboardFiltersScope = action.scopes;\n    // update filter scope for each filter field\n    const updatedFilters = Object.entries(allDashboardFiltersScope).reduce(\n      (map, entry) => {\n        const [filterKey, { scope, immune }] = entry;\n        const { chartId, column } = getChartIdAndColumnFromFilterKey(filterKey);\n        const scopes = {\n          ...map[chartId].scopes,\n          [column]: {\n            scope,\n            immune,\n          },\n        };\n        return {\n          ...map,\n          [chartId]: {\n            ...map[chartId],\n            scopes,\n          },\n        };\n      },\n      dashboardFilters,\n    );\n\n    buildActiveFilters({ dashboardFilters: updatedFilters });\n    return updatedFilters;\n  } else if (action.type === REMOVE_FILTER) {\n    const { chartId } = action;\n    const { [chartId]: deletedFilter, ...updatedFilters } = dashboardFilters;\n    buildActiveFilters({ dashboardFilters: updatedFilters });\n    buildFilterColorMap(updatedFilters);\n\n    return updatedFilters;\n  } else if (action.type in actionHandlers) {\n    const updatedFilters = {\n      ...dashboardFilters,\n      [action.chartId]: actionHandlers[action.type](\n        dashboardFilters[action.chartId],\n      ),\n    };\n\n    if (CHANGE_FILTER_VALUE_ACTIONS.includes(action.type)) {\n      buildActiveFilters({ dashboardFilters: updatedFilters });\n      buildFilterColorMap(updatedFilters);\n    }\n\n    return updatedFilters;\n  }\n\n  return dashboardFilters;\n}\n"]},"metadata":{},"sourceType":"module"}