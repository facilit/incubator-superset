{"ast":null,"code":"import _extends from \"@babel/runtime-corejs3/helpers/extends\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _objectWithoutPropertiesLoose from \"@babel/runtime-corejs3/helpers/objectWithoutPropertiesLoose\";import _setTimeout from \"@babel/runtime-corejs3/core-js-stable/set-timeout\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _concatInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/concat\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport {\nButton,\nControlLabel,\nFormGroup,\nPopover,\nTab,\nTabs } from\n'react-bootstrap';\nimport Select from 'src/components/Select';\nimport ace from 'brace';\nimport AceEditor from 'react-ace';\nimport 'brace/mode/sql';\nimport 'brace/theme/github';\nimport 'brace/ext/language_tools';\nimport { t } from '@superset-ui/translation';\nimport { ColumnOption } from '@superset-ui/chart-controls';\n\nimport { AGGREGATES, AGGREGATES_OPTIONS } from '../constants';\nimport AdhocMetricEditPopoverTitle from './AdhocMetricEditPopoverTitle';\nimport columnType from '../propTypes/columnType';\nimport AdhocMetric, { EXPRESSION_TYPES } from '../AdhocMetric';\nimport sqlKeywords from '../../SqlLab/utils/sqlKeywords';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst langTools = ace.acequire('ace/ext/language_tools');\n\nconst propTypes = {\n  adhocMetric: PropTypes.instanceOf(AdhocMetric).isRequired,\n  onChange: PropTypes.func.isRequired,\n  onClose: PropTypes.func.isRequired,\n  onResize: PropTypes.func.isRequired,\n  columns: PropTypes.arrayOf(columnType),\n  datasourceType: PropTypes.string };\n\n\nconst defaultProps = {\n  columns: [] };\n\n\nconst startingWidth = 300;\nconst startingHeight = 180;\n\nexport default class AdhocMetricEditPopover extends React.Component {\n  constructor(props) {var _context, _context2, _context3, _context4, _context5, _context6, _context7, _context8, _context9, _context10;\n    super(props);\n    this.onSave = _bindInstanceProperty(_context = this.onSave).call(_context, this);\n    this.onColumnChange = _bindInstanceProperty(_context2 = this.onColumnChange).call(_context2, this);\n    this.onAggregateChange = _bindInstanceProperty(_context3 = this.onAggregateChange).call(_context3, this);\n    this.onSqlExpressionChange = _bindInstanceProperty(_context4 = this.onSqlExpressionChange).call(_context4, this);\n    this.onLabelChange = _bindInstanceProperty(_context5 = this.onLabelChange).call(_context5, this);\n    this.onDragDown = _bindInstanceProperty(_context6 = this.onDragDown).call(_context6, this);\n    this.onMouseMove = _bindInstanceProperty(_context7 = this.onMouseMove).call(_context7, this);\n    this.onMouseUp = _bindInstanceProperty(_context8 = this.onMouseUp).call(_context8, this);\n    this.handleAceEditorRef = _bindInstanceProperty(_context9 = this.handleAceEditorRef).call(_context9, this);\n    this.refreshAceEditor = _bindInstanceProperty(_context10 = this.refreshAceEditor).call(_context10, this);\n    this.state = {\n      adhocMetric: this.props.adhocMetric,\n      width: startingWidth,\n      height: startingHeight };\n\n    this.selectProps = {\n      labelKey: 'label',\n      isMulti: false,\n      autosize: false,\n      clearable: true };\n\n    if (langTools) {var _context11;\n      const words = _concatInstanceProperty(sqlKeywords).call(sqlKeywords,\n      _mapInstanceProperty(_context11 = this.props.columns).call(_context11, column => ({\n        name: column.column_name,\n        value: column.column_name,\n        score: 50,\n        meta: 'column' })));\n\n\n      const completer = {\n        getCompletions: (aceEditor, session, pos, prefix, callback) => {\n          callback(null, words);\n        } };\n\n      langTools.setCompleters([completer]);\n    }\n    document.addEventListener('mouseup', this.onMouseUp);\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('mouseup', this.onMouseUp);\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  onSave() {\n    this.props.onChange(this.state.adhocMetric);\n    this.props.onClose();\n  }\n\n  onColumnChange(column) {\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        column,\n        expressionType: EXPRESSION_TYPES.SIMPLE }) });\n\n\n  }\n\n  onAggregateChange(aggregate) {\n    // we construct this object explicitly to overwrite the value in the case aggregate is null\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        aggregate,\n        expressionType: EXPRESSION_TYPES.SIMPLE }) });\n\n\n  }\n\n  onSqlExpressionChange(sqlExpression) {\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        sqlExpression,\n        expressionType: EXPRESSION_TYPES.SQL }) });\n\n\n  }\n\n  onLabelChange(e) {\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        label: e.target.value,\n        hasCustomLabel: true }) });\n\n\n  }\n\n  onDragDown(e) {\n    this.dragStartX = e.clientX;\n    this.dragStartY = e.clientY;\n    this.dragStartWidth = this.state.width;\n    this.dragStartHeight = this.state.height;\n    document.addEventListener('mousemove', this.onMouseMove);\n  }\n\n  onMouseMove(e) {\n    this.props.onResize();\n    this.setState({\n      width: Math.max(\n      this.dragStartWidth + (e.clientX - this.dragStartX),\n      startingWidth),\n\n      height: Math.max(\n      this.dragStartHeight + (e.clientY - this.dragStartY) * 2,\n      startingHeight) });\n\n\n  }\n\n  onMouseUp() {\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  handleAceEditorRef(ref) {\n    if (ref) {\n      this.aceEditorRef = ref;\n    }\n  }\n\n  refreshAceEditor() {\n    _setTimeout(() => this.aceEditorRef.editor.resize(), 0);\n  }\n\n  renderColumnOption(option) {\n    return ___EmotionJSX(ColumnOption, { column: option, showType: true });\n  }\n\n  render() {\n    const _this$props =\n\n\n\n\n\n\n\n    this.props,{ adhocMetric: propsAdhocMetric, columns } = _this$props,popoverProps = _objectWithoutPropertiesLoose(_this$props, [\"adhocMetric\", \"columns\", \"onChange\", \"onClose\", \"onResize\", \"datasourceType\"]);\n\n    const { adhocMetric } = this.state;\n\n    const columnSelectProps = {\n      placeholder: t('%s column(s)', columns.length),\n      options: columns,\n      value:\n      adhocMetric.column && adhocMetric.column.column_name ||\n      adhocMetric.inferSqlExpressionColumn(),\n      onChange: this.onColumnChange,\n      optionRenderer: this.renderColumnOption,\n      valueKey: 'column_name' };\n\n\n    const aggregateSelectProps = {\n      placeholder: t('%s aggregates(s)', AGGREGATES_OPTIONS.length),\n      options: AGGREGATES_OPTIONS,\n      value: adhocMetric.aggregate || adhocMetric.inferSqlExpressionAggregate(),\n      onChange: this.onAggregateChange };\n\n\n    if (this.props.datasourceType === 'druid') {var _context12;\n      aggregateSelectProps.options = _filterInstanceProperty(_context12 = aggregateSelectProps.options).call(_context12,\n      aggregate => aggregate !== 'AVG');\n\n    }\n\n    const popoverTitle =\n    ___EmotionJSX(AdhocMetricEditPopoverTitle, {\n      adhocMetric: adhocMetric,\n      onChange: this.onLabelChange });\n\n\n\n    const stateIsValid = adhocMetric.isValid();\n    const hasUnsavedChanges = !adhocMetric.equals(propsAdhocMetric);\n    return (\n      ___EmotionJSX(Popover, _extends({ id: \"metrics-edit-popover\", title: popoverTitle }, popoverProps),\n      ___EmotionJSX(Tabs, {\n        id: \"adhoc-metric-edit-tabs\",\n        defaultActiveKey: adhocMetric.expressionType,\n        className: \"adhoc-metric-edit-tabs\",\n        style: { height: this.state.height, width: this.state.width },\n        onSelect: this.refreshAceEditor,\n        animation: false },\n\n      ___EmotionJSX(Tab, {\n        className: \"adhoc-metric-edit-tab\",\n        eventKey: EXPRESSION_TYPES.SIMPLE,\n        title: \"Simple\" },\n\n      ___EmotionJSX(FormGroup, null,\n      ___EmotionJSX(ControlLabel, null,\n      ___EmotionJSX(\"strong\", null, \"column\")),\n\n      ___EmotionJSX(Select, _extends({\n        name: \"select-column\" },\n      this.selectProps,\n      columnSelectProps))),\n\n\n      ___EmotionJSX(FormGroup, null,\n      ___EmotionJSX(ControlLabel, null,\n      ___EmotionJSX(\"strong\", null, \"aggregate\")),\n\n      ___EmotionJSX(Select, _extends({\n        name: \"select-aggregate\" },\n      this.selectProps,\n      aggregateSelectProps, {\n        autoFocus: true })))),\n\n\n\n      ___EmotionJSX(Tab, {\n        className: \"adhoc-metric-edit-tab\",\n        eventKey: EXPRESSION_TYPES.SQL,\n        title: \"Custom SQL\" },\n\n      this.props.datasourceType !== 'druid' ?\n      ___EmotionJSX(FormGroup, null,\n      ___EmotionJSX(AceEditor, {\n        ref: this.handleAceEditorRef,\n        mode: \"sql\",\n        theme: \"github\",\n        height: this.state.height - 43 + 'px',\n        onChange: this.onSqlExpressionChange,\n        width: \"100%\",\n        showGutter: false,\n        value:\n        adhocMetric.sqlExpression || adhocMetric.translateToSql(),\n\n        editorProps: { $blockScrolling: true },\n        enableLiveAutocompletion: true,\n        className: \"adhoc-filter-sql-editor\",\n        wrapEnabled: true })) :\n\n\n\n      ___EmotionJSX(\"div\", { className: \"custom-sql-disabled-message\" }, \"Custom SQL Metrics are not available on druid datasources\"))),\n\n\n\n\n\n      ___EmotionJSX(\"div\", null,\n      ___EmotionJSX(Button, {\n        disabled: !stateIsValid,\n        bsStyle: hasUnsavedChanges && stateIsValid ? 'primary' : 'default',\n        bsSize: \"small\",\n        className: \"m-r-5\",\n        onClick: this.onSave }, \"Save\"),\n\n\n\n      ___EmotionJSX(Button, { bsSize: \"small\", onClick: this.props.onClose }, \"Close\"),\n\n\n      ___EmotionJSX(\"i\", {\n        onMouseDown: this.onDragDown,\n        className: \"fa fa-expand edit-popover-resize text-muted\" }))));\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}AdhocMetricEditPopover.propTypes = propTypes;\nAdhocMetricEditPopover.defaultProps = defaultProps;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(langTools, \"langTools\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");reactHotLoader.register(propTypes, \"propTypes\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");reactHotLoader.register(defaultProps, \"defaultProps\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");reactHotLoader.register(startingWidth, \"startingWidth\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");reactHotLoader.register(startingHeight, \"startingHeight\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");reactHotLoader.register(AdhocMetricEditPopover, \"AdhocMetricEditPopover\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/AdhocMetricEditPopover.jsx"],"names":["React","PropTypes","Button","ControlLabel","FormGroup","Popover","Tab","Tabs","Select","ace","AceEditor","t","ColumnOption","AGGREGATES","AGGREGATES_OPTIONS","AdhocMetricEditPopoverTitle","columnType","AdhocMetric","EXPRESSION_TYPES","sqlKeywords","langTools","acequire","propTypes","adhocMetric","instanceOf","isRequired","onChange","func","onClose","onResize","columns","arrayOf","datasourceType","string","defaultProps","startingWidth","startingHeight","AdhocMetricEditPopover","Component","constructor","props","onSave","onColumnChange","onAggregateChange","onSqlExpressionChange","onLabelChange","onDragDown","onMouseMove","onMouseUp","handleAceEditorRef","refreshAceEditor","state","width","height","selectProps","labelKey","isMulti","autosize","clearable","words","column","name","column_name","value","score","meta","completer","getCompletions","aceEditor","session","pos","prefix","callback","setCompleters","document","addEventListener","componentWillUnmount","removeEventListener","setState","duplicateWith","expressionType","SIMPLE","aggregate","sqlExpression","SQL","e","label","target","hasCustomLabel","dragStartX","clientX","dragStartY","clientY","dragStartWidth","dragStartHeight","Math","max","ref","aceEditorRef","editor","resize","renderColumnOption","option","render","propsAdhocMetric","popoverProps","columnSelectProps","placeholder","length","options","inferSqlExpressionColumn","optionRenderer","valueKey","aggregateSelectProps","inferSqlExpressionAggregate","popoverTitle","stateIsValid","isValid","hasUnsavedChanges","equals","translateToSql","$blockScrolling"],"mappings":"g4BAAA;;;;;;;;;;;;;;;;;;AAkBA,OAAOA,KAAP,MAAkB,OAAlB;AACA,OAAOC,SAAP,MAAsB,YAAtB;AACA;AACEC,MADF;AAEEC,YAFF;AAGEC,SAHF;AAIEC,OAJF;AAKEC,GALF;AAMEC,IANF;AAOO,iBAPP;AAQA,OAAOC,MAAP,MAAmB,uBAAnB;AACA,OAAOC,GAAP,MAAgB,OAAhB;AACA,OAAOC,SAAP,MAAsB,WAAtB;AACA,OAAO,gBAAP;AACA,OAAO,oBAAP;AACA,OAAO,0BAAP;AACA,SAASC,CAAT,QAAkB,0BAAlB;AACA,SAASC,YAAT,QAA6B,6BAA7B;;AAEA,SAASC,UAAT,EAAqBC,kBAArB,QAA+C,cAA/C;AACA,OAAOC,2BAAP,MAAwC,+BAAxC;AACA,OAAOC,UAAP,MAAuB,yBAAvB;AACA,OAAOC,WAAP,IAAsBC,gBAAtB,QAA8C,gBAA9C;AACA,OAAOC,WAAP,MAAwB,gCAAxB,C;;AAEA,MAAMC,SAAS,GAAGX,GAAG,CAACY,QAAJ,CAAa,wBAAb,CAAlB;;AAEA,MAAMC,SAAS,GAAG;AAChBC,EAAAA,WAAW,EAAEtB,SAAS,CAACuB,UAAV,CAAqBP,WAArB,EAAkCQ,UAD/B;AAEhBC,EAAAA,QAAQ,EAAEzB,SAAS,CAAC0B,IAAV,CAAeF,UAFT;AAGhBG,EAAAA,OAAO,EAAE3B,SAAS,CAAC0B,IAAV,CAAeF,UAHR;AAIhBI,EAAAA,QAAQ,EAAE5B,SAAS,CAAC0B,IAAV,CAAeF,UAJT;AAKhBK,EAAAA,OAAO,EAAE7B,SAAS,CAAC8B,OAAV,CAAkBf,UAAlB,CALO;AAMhBgB,EAAAA,cAAc,EAAE/B,SAAS,CAACgC,MANV,EAAlB;;;AASA,MAAMC,YAAY,GAAG;AACnBJ,EAAAA,OAAO,EAAE,EADU,EAArB;;;AAIA,MAAMK,aAAa,GAAG,GAAtB;AACA,MAAMC,cAAc,GAAG,GAAvB;;AAEA,eAAe,MAAMC,sBAAN,SAAqCrC,KAAK,CAACsC,SAA3C,CAAqD;AAClEC,EAAAA,WAAW,CAACC,KAAD,EAAQ;AACjB,UAAMA,KAAN;AACA,SAAKC,MAAL,GAAc,sCAAKA,MAAL,iBAAiB,IAAjB,CAAd;AACA,SAAKC,cAAL,GAAsB,uCAAKA,cAAL,kBAAyB,IAAzB,CAAtB;AACA,SAAKC,iBAAL,GAAyB,uCAAKA,iBAAL,kBAA4B,IAA5B,CAAzB;AACA,SAAKC,qBAAL,GAA6B,uCAAKA,qBAAL,kBAAgC,IAAhC,CAA7B;AACA,SAAKC,aAAL,GAAqB,uCAAKA,aAAL,kBAAwB,IAAxB,CAArB;AACA,SAAKC,UAAL,GAAkB,uCAAKA,UAAL,kBAAqB,IAArB,CAAlB;AACA,SAAKC,WAAL,GAAmB,uCAAKA,WAAL,kBAAsB,IAAtB,CAAnB;AACA,SAAKC,SAAL,GAAiB,uCAAKA,SAAL,kBAAoB,IAApB,CAAjB;AACA,SAAKC,kBAAL,GAA0B,uCAAKA,kBAAL,kBAA6B,IAA7B,CAA1B;AACA,SAAKC,gBAAL,GAAwB,wCAAKA,gBAAL,mBAA2B,IAA3B,CAAxB;AACA,SAAKC,KAAL,GAAa;AACX5B,MAAAA,WAAW,EAAE,KAAKiB,KAAL,CAAWjB,WADb;AAEX6B,MAAAA,KAAK,EAAEjB,aAFI;AAGXkB,MAAAA,MAAM,EAAEjB,cAHG,EAAb;;AAKA,SAAKkB,WAAL,GAAmB;AACjBC,MAAAA,QAAQ,EAAE,OADO;AAEjBC,MAAAA,OAAO,EAAE,KAFQ;AAGjBC,MAAAA,QAAQ,EAAE,KAHO;AAIjBC,MAAAA,SAAS,EAAE,IAJM,EAAnB;;AAMA,QAAItC,SAAJ,EAAe;AACb,YAAMuC,KAAK,GAAG,wBAAAxC,WAAW,MAAX,CAAAA,WAAW;AACvB,6CAAKqB,KAAL,CAAWV,OAAX,mBAAuB8B,MAAM,KAAK;AAChCC,QAAAA,IAAI,EAAED,MAAM,CAACE,WADmB;AAEhCC,QAAAA,KAAK,EAAEH,MAAM,CAACE,WAFkB;AAGhCE,QAAAA,KAAK,EAAE,EAHyB;AAIhCC,QAAAA,IAAI,EAAE,QAJ0B,EAAL,CAA7B,CADuB,CAAzB;;;AAQA,YAAMC,SAAS,GAAG;AAChBC,QAAAA,cAAc,EAAE,CAACC,SAAD,EAAYC,OAAZ,EAAqBC,GAArB,EAA0BC,MAA1B,EAAkCC,QAAlC,KAA+C;AAC7DA,UAAAA,QAAQ,CAAC,IAAD,EAAOb,KAAP,CAAR;AACD,SAHe,EAAlB;;AAKAvC,MAAAA,SAAS,CAACqD,aAAV,CAAwB,CAACP,SAAD,CAAxB;AACD;AACDQ,IAAAA,QAAQ,CAACC,gBAAT,CAA0B,SAA1B,EAAqC,KAAK3B,SAA1C;AACD;;AAED4B,EAAAA,oBAAoB,GAAG;AACrBF,IAAAA,QAAQ,CAACG,mBAAT,CAA6B,SAA7B,EAAwC,KAAK7B,SAA7C;AACA0B,IAAAA,QAAQ,CAACG,mBAAT,CAA6B,WAA7B,EAA0C,KAAK9B,WAA/C;AACD;;AAEDN,EAAAA,MAAM,GAAG;AACP,SAAKD,KAAL,CAAWd,QAAX,CAAoB,KAAKyB,KAAL,CAAW5B,WAA/B;AACA,SAAKiB,KAAL,CAAWZ,OAAX;AACD;;AAEDc,EAAAA,cAAc,CAACkB,MAAD,EAAS;AACrB,SAAKkB,QAAL,CAAc;AACZvD,MAAAA,WAAW,EAAE,KAAK4B,KAAL,CAAW5B,WAAX,CAAuBwD,aAAvB,CAAqC;AAChDnB,QAAAA,MADgD;AAEhDoB,QAAAA,cAAc,EAAE9D,gBAAgB,CAAC+D,MAFe,EAArC,CADD,EAAd;;;AAMD;;AAEDtC,EAAAA,iBAAiB,CAACuC,SAAD,EAAY;AAC3B;AACA,SAAKJ,QAAL,CAAc;AACZvD,MAAAA,WAAW,EAAE,KAAK4B,KAAL,CAAW5B,WAAX,CAAuBwD,aAAvB,CAAqC;AAChDG,QAAAA,SADgD;AAEhDF,QAAAA,cAAc,EAAE9D,gBAAgB,CAAC+D,MAFe,EAArC,CADD,EAAd;;;AAMD;;AAEDrC,EAAAA,qBAAqB,CAACuC,aAAD,EAAgB;AACnC,SAAKL,QAAL,CAAc;AACZvD,MAAAA,WAAW,EAAE,KAAK4B,KAAL,CAAW5B,WAAX,CAAuBwD,aAAvB,CAAqC;AAChDI,QAAAA,aADgD;AAEhDH,QAAAA,cAAc,EAAE9D,gBAAgB,CAACkE,GAFe,EAArC,CADD,EAAd;;;AAMD;;AAEDvC,EAAAA,aAAa,CAACwC,CAAD,EAAI;AACf,SAAKP,QAAL,CAAc;AACZvD,MAAAA,WAAW,EAAE,KAAK4B,KAAL,CAAW5B,WAAX,CAAuBwD,aAAvB,CAAqC;AAChDO,QAAAA,KAAK,EAAED,CAAC,CAACE,MAAF,CAASxB,KADgC;AAEhDyB,QAAAA,cAAc,EAAE,IAFgC,EAArC,CADD,EAAd;;;AAMD;;AAED1C,EAAAA,UAAU,CAACuC,CAAD,EAAI;AACZ,SAAKI,UAAL,GAAkBJ,CAAC,CAACK,OAApB;AACA,SAAKC,UAAL,GAAkBN,CAAC,CAACO,OAApB;AACA,SAAKC,cAAL,GAAsB,KAAK1C,KAAL,CAAWC,KAAjC;AACA,SAAK0C,eAAL,GAAuB,KAAK3C,KAAL,CAAWE,MAAlC;AACAqB,IAAAA,QAAQ,CAACC,gBAAT,CAA0B,WAA1B,EAAuC,KAAK5B,WAA5C;AACD;;AAEDA,EAAAA,WAAW,CAACsC,CAAD,EAAI;AACb,SAAK7C,KAAL,CAAWX,QAAX;AACA,SAAKiD,QAAL,CAAc;AACZ1B,MAAAA,KAAK,EAAE2C,IAAI,CAACC,GAAL;AACL,WAAKH,cAAL,IAAuBR,CAAC,CAACK,OAAF,GAAY,KAAKD,UAAxC,CADK;AAELtD,MAAAA,aAFK,CADK;;AAKZkB,MAAAA,MAAM,EAAE0C,IAAI,CAACC,GAAL;AACN,WAAKF,eAAL,GAAuB,CAACT,CAAC,CAACO,OAAF,GAAY,KAAKD,UAAlB,IAAgC,CADjD;AAENvD,MAAAA,cAFM,CALI,EAAd;;;AAUD;;AAEDY,EAAAA,SAAS,GAAG;AACV0B,IAAAA,QAAQ,CAACG,mBAAT,CAA6B,WAA7B,EAA0C,KAAK9B,WAA/C;AACD;;AAEDE,EAAAA,kBAAkB,CAACgD,GAAD,EAAM;AACtB,QAAIA,GAAJ,EAAS;AACP,WAAKC,YAAL,GAAoBD,GAApB;AACD;AACF;;AAED/C,EAAAA,gBAAgB,GAAG;AACjB,gBAAW,MAAM,KAAKgD,YAAL,CAAkBC,MAAlB,CAAyBC,MAAzB,EAAjB,EAAoD,CAApD;AACD;;AAEDC,EAAAA,kBAAkB,CAACC,MAAD,EAAS;AACzB,WAAO,cAAC,YAAD,IAAc,MAAM,EAAEA,MAAtB,EAA8B,QAAQ,MAAtC,GAAP;AACD;;AAEDC,EAAAA,MAAM,GAAG;AACP;;;;;;;;AAQI,SAAK/D,KART,CAAM,EACJjB,WAAW,EAAEiF,gBADT,EAEJ1E,OAFI,EAAN,eAOK2E,YAPL;;AAUA,UAAM,EAAElF,WAAF,KAAkB,KAAK4B,KAA7B;;AAEA,UAAMuD,iBAAiB,GAAG;AACxBC,MAAAA,WAAW,EAAEhG,CAAC,CAAC,cAAD,EAAiBmB,OAAO,CAAC8E,MAAzB,CADU;AAExBC,MAAAA,OAAO,EAAE/E,OAFe;AAGxBiC,MAAAA,KAAK;AACFxC,MAAAA,WAAW,CAACqC,MAAZ,IAAsBrC,WAAW,CAACqC,MAAZ,CAAmBE,WAA1C;AACAvC,MAAAA,WAAW,CAACuF,wBAAZ,EALsB;AAMxBpF,MAAAA,QAAQ,EAAE,KAAKgB,cANS;AAOxBqE,MAAAA,cAAc,EAAE,KAAKV,kBAPG;AAQxBW,MAAAA,QAAQ,EAAE,aARc,EAA1B;;;AAWA,UAAMC,oBAAoB,GAAG;AAC3BN,MAAAA,WAAW,EAAEhG,CAAC,CAAC,kBAAD,EAAqBG,kBAAkB,CAAC8F,MAAxC,CADa;AAE3BC,MAAAA,OAAO,EAAE/F,kBAFkB;AAG3BiD,MAAAA,KAAK,EAAExC,WAAW,CAAC2D,SAAZ,IAAyB3D,WAAW,CAAC2F,2BAAZ,EAHL;AAI3BxF,MAAAA,QAAQ,EAAE,KAAKiB,iBAJY,EAA7B;;;AAOA,QAAI,KAAKH,KAAL,CAAWR,cAAX,KAA8B,OAAlC,EAA2C;AACzCiF,MAAAA,oBAAoB,CAACJ,OAArB,GAA+B,qCAAAI,oBAAoB,CAACJ,OAArB;AAC7B3B,MAAAA,SAAS,IAAIA,SAAS,KAAK,KADE,CAA/B;;AAGD;;AAED,UAAMiC,YAAY;AAChB,kBAAC,2BAAD;AACE,MAAA,WAAW,EAAE5F,WADf;AAEE,MAAA,QAAQ,EAAE,KAAKsB,aAFjB,GADF;;;;AAOA,UAAMuE,YAAY,GAAG7F,WAAW,CAAC8F,OAAZ,EAArB;AACA,UAAMC,iBAAiB,GAAG,CAAC/F,WAAW,CAACgG,MAAZ,CAAmBf,gBAAnB,CAA3B;AACA;AACE,oBAAC,OAAD,aAAS,EAAE,EAAC,sBAAZ,EAAmC,KAAK,EAAEW,YAA1C,IAA4DV,YAA5D;AACE,oBAAC,IAAD;AACE,QAAA,EAAE,EAAC,wBADL;AAEE,QAAA,gBAAgB,EAAElF,WAAW,CAACyD,cAFhC;AAGE,QAAA,SAAS,EAAC,wBAHZ;AAIE,QAAA,KAAK,EAAE,EAAE3B,MAAM,EAAE,KAAKF,KAAL,CAAWE,MAArB,EAA6BD,KAAK,EAAE,KAAKD,KAAL,CAAWC,KAA/C,EAJT;AAKE,QAAA,QAAQ,EAAE,KAAKF,gBALjB;AAME,QAAA,SAAS,EAAE,KANb;;AAQE,oBAAC,GAAD;AACE,QAAA,SAAS,EAAC,uBADZ;AAEE,QAAA,QAAQ,EAAEhC,gBAAgB,CAAC+D,MAF7B;AAGE,QAAA,KAAK,EAAC,QAHR;;AAKE,oBAAC,SAAD;AACE,oBAAC,YAAD;AACE,6CADF,CADF;;AAIE,oBAAC,MAAD;AACE,QAAA,IAAI,EAAC,eADP;AAEM,WAAK3B,WAFX;AAGMoD,MAAAA,iBAHN,EAJF,CALF;;;AAeE,oBAAC,SAAD;AACE,oBAAC,YAAD;AACE,gDADF,CADF;;AAIE,oBAAC,MAAD;AACE,QAAA,IAAI,EAAC,kBADP;AAEM,WAAKpD,WAFX;AAGM2D,MAAAA,oBAHN;AAIE,QAAA,SAAS,MAJX,IAJF,CAfF,CARF;;;;AAmCE,oBAAC,GAAD;AACE,QAAA,SAAS,EAAC,uBADZ;AAEE,QAAA,QAAQ,EAAE/F,gBAAgB,CAACkE,GAF7B;AAGE,QAAA,KAAK,EAAC,YAHR;;AAKG,WAAK5C,KAAL,CAAWR,cAAX,KAA8B,OAA9B;AACC,oBAAC,SAAD;AACE,oBAAC,SAAD;AACE,QAAA,GAAG,EAAE,KAAKiB,kBADZ;AAEE,QAAA,IAAI,EAAC,KAFP;AAGE,QAAA,KAAK,EAAC,QAHR;AAIE,QAAA,MAAM,EAAE,KAAKE,KAAL,CAAWE,MAAX,GAAoB,EAApB,GAAyB,IAJnC;AAKE,QAAA,QAAQ,EAAE,KAAKT,qBALjB;AAME,QAAA,KAAK,EAAC,MANR;AAOE,QAAA,UAAU,EAAE,KAPd;AAQE,QAAA,KAAK;AACHrB,QAAAA,WAAW,CAAC4D,aAAZ,IAA6B5D,WAAW,CAACiG,cAAZ,EATjC;;AAWE,QAAA,WAAW,EAAE,EAAEC,eAAe,EAAE,IAAnB,EAXf;AAYE,QAAA,wBAAwB,MAZ1B;AAaE,QAAA,SAAS,EAAC,yBAbZ;AAcE,QAAA,WAAW,MAdb,GADF,CADD;;;;AAoBC,6BAAK,SAAS,EAAC,6BAAf,gEAzBJ,CAnCF,CADF;;;;;;AAmEE;AACE,oBAAC,MAAD;AACE,QAAA,QAAQ,EAAE,CAACL,YADb;AAEE,QAAA,OAAO,EAAEE,iBAAiB,IAAIF,YAArB,GAAoC,SAApC,GAAgD,SAF3D;AAGE,QAAA,MAAM,EAAC,OAHT;AAIE,QAAA,SAAS,EAAC,OAJZ;AAKE,QAAA,OAAO,EAAE,KAAK3E,MALhB,WADF;;;;AAUE,oBAAC,MAAD,IAAQ,MAAM,EAAC,OAAf,EAAuB,OAAO,EAAE,KAAKD,KAAL,CAAWZ,OAA3C,YAVF;;;AAaE;AACE,QAAA,WAAW,EAAE,KAAKkB,UADpB;AAEE,QAAA,SAAS,EAAC,6CAFZ,GAbF,CAnEF,CADF;;;;;AAwFD,GAxQiE;AAAA;AAAA,6BA0QpET,sBAAsB,CAACf,SAAvB,GAAmCA,SAAnC;AACAe,sBAAsB,CAACH,YAAvB,GAAsCA,YAAtC,C,iLA7RMd,S,yJAEAE,S,yJASAY,Y,4JAIAC,a,6JACAC,c,8JAEeC,sB","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport {\n  Button,\n  ControlLabel,\n  FormGroup,\n  Popover,\n  Tab,\n  Tabs,\n} from 'react-bootstrap';\nimport Select from 'src/components/Select';\nimport ace from 'brace';\nimport AceEditor from 'react-ace';\nimport 'brace/mode/sql';\nimport 'brace/theme/github';\nimport 'brace/ext/language_tools';\nimport { t } from '@superset-ui/translation';\nimport { ColumnOption } from '@superset-ui/chart-controls';\n\nimport { AGGREGATES, AGGREGATES_OPTIONS } from '../constants';\nimport AdhocMetricEditPopoverTitle from './AdhocMetricEditPopoverTitle';\nimport columnType from '../propTypes/columnType';\nimport AdhocMetric, { EXPRESSION_TYPES } from '../AdhocMetric';\nimport sqlKeywords from '../../SqlLab/utils/sqlKeywords';\n\nconst langTools = ace.acequire('ace/ext/language_tools');\n\nconst propTypes = {\n  adhocMetric: PropTypes.instanceOf(AdhocMetric).isRequired,\n  onChange: PropTypes.func.isRequired,\n  onClose: PropTypes.func.isRequired,\n  onResize: PropTypes.func.isRequired,\n  columns: PropTypes.arrayOf(columnType),\n  datasourceType: PropTypes.string,\n};\n\nconst defaultProps = {\n  columns: [],\n};\n\nconst startingWidth = 300;\nconst startingHeight = 180;\n\nexport default class AdhocMetricEditPopover extends React.Component {\n  constructor(props) {\n    super(props);\n    this.onSave = this.onSave.bind(this);\n    this.onColumnChange = this.onColumnChange.bind(this);\n    this.onAggregateChange = this.onAggregateChange.bind(this);\n    this.onSqlExpressionChange = this.onSqlExpressionChange.bind(this);\n    this.onLabelChange = this.onLabelChange.bind(this);\n    this.onDragDown = this.onDragDown.bind(this);\n    this.onMouseMove = this.onMouseMove.bind(this);\n    this.onMouseUp = this.onMouseUp.bind(this);\n    this.handleAceEditorRef = this.handleAceEditorRef.bind(this);\n    this.refreshAceEditor = this.refreshAceEditor.bind(this);\n    this.state = {\n      adhocMetric: this.props.adhocMetric,\n      width: startingWidth,\n      height: startingHeight,\n    };\n    this.selectProps = {\n      labelKey: 'label',\n      isMulti: false,\n      autosize: false,\n      clearable: true,\n    };\n    if (langTools) {\n      const words = sqlKeywords.concat(\n        this.props.columns.map(column => ({\n          name: column.column_name,\n          value: column.column_name,\n          score: 50,\n          meta: 'column',\n        })),\n      );\n      const completer = {\n        getCompletions: (aceEditor, session, pos, prefix, callback) => {\n          callback(null, words);\n        },\n      };\n      langTools.setCompleters([completer]);\n    }\n    document.addEventListener('mouseup', this.onMouseUp);\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('mouseup', this.onMouseUp);\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  onSave() {\n    this.props.onChange(this.state.adhocMetric);\n    this.props.onClose();\n  }\n\n  onColumnChange(column) {\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        column,\n        expressionType: EXPRESSION_TYPES.SIMPLE,\n      }),\n    });\n  }\n\n  onAggregateChange(aggregate) {\n    // we construct this object explicitly to overwrite the value in the case aggregate is null\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        aggregate,\n        expressionType: EXPRESSION_TYPES.SIMPLE,\n      }),\n    });\n  }\n\n  onSqlExpressionChange(sqlExpression) {\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        sqlExpression,\n        expressionType: EXPRESSION_TYPES.SQL,\n      }),\n    });\n  }\n\n  onLabelChange(e) {\n    this.setState({\n      adhocMetric: this.state.adhocMetric.duplicateWith({\n        label: e.target.value,\n        hasCustomLabel: true,\n      }),\n    });\n  }\n\n  onDragDown(e) {\n    this.dragStartX = e.clientX;\n    this.dragStartY = e.clientY;\n    this.dragStartWidth = this.state.width;\n    this.dragStartHeight = this.state.height;\n    document.addEventListener('mousemove', this.onMouseMove);\n  }\n\n  onMouseMove(e) {\n    this.props.onResize();\n    this.setState({\n      width: Math.max(\n        this.dragStartWidth + (e.clientX - this.dragStartX),\n        startingWidth,\n      ),\n      height: Math.max(\n        this.dragStartHeight + (e.clientY - this.dragStartY) * 2,\n        startingHeight,\n      ),\n    });\n  }\n\n  onMouseUp() {\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  handleAceEditorRef(ref) {\n    if (ref) {\n      this.aceEditorRef = ref;\n    }\n  }\n\n  refreshAceEditor() {\n    setTimeout(() => this.aceEditorRef.editor.resize(), 0);\n  }\n\n  renderColumnOption(option) {\n    return <ColumnOption column={option} showType />;\n  }\n\n  render() {\n    const {\n      adhocMetric: propsAdhocMetric,\n      columns,\n      onChange,\n      onClose,\n      onResize,\n      datasourceType,\n      ...popoverProps\n    } = this.props;\n\n    const { adhocMetric } = this.state;\n\n    const columnSelectProps = {\n      placeholder: t('%s column(s)', columns.length),\n      options: columns,\n      value:\n        (adhocMetric.column && adhocMetric.column.column_name) ||\n        adhocMetric.inferSqlExpressionColumn(),\n      onChange: this.onColumnChange,\n      optionRenderer: this.renderColumnOption,\n      valueKey: 'column_name',\n    };\n\n    const aggregateSelectProps = {\n      placeholder: t('%s aggregates(s)', AGGREGATES_OPTIONS.length),\n      options: AGGREGATES_OPTIONS,\n      value: adhocMetric.aggregate || adhocMetric.inferSqlExpressionAggregate(),\n      onChange: this.onAggregateChange,\n    };\n\n    if (this.props.datasourceType === 'druid') {\n      aggregateSelectProps.options = aggregateSelectProps.options.filter(\n        aggregate => aggregate !== 'AVG',\n      );\n    }\n\n    const popoverTitle = (\n      <AdhocMetricEditPopoverTitle\n        adhocMetric={adhocMetric}\n        onChange={this.onLabelChange}\n      />\n    );\n\n    const stateIsValid = adhocMetric.isValid();\n    const hasUnsavedChanges = !adhocMetric.equals(propsAdhocMetric);\n    return (\n      <Popover id=\"metrics-edit-popover\" title={popoverTitle} {...popoverProps}>\n        <Tabs\n          id=\"adhoc-metric-edit-tabs\"\n          defaultActiveKey={adhocMetric.expressionType}\n          className=\"adhoc-metric-edit-tabs\"\n          style={{ height: this.state.height, width: this.state.width }}\n          onSelect={this.refreshAceEditor}\n          animation={false}\n        >\n          <Tab\n            className=\"adhoc-metric-edit-tab\"\n            eventKey={EXPRESSION_TYPES.SIMPLE}\n            title=\"Simple\"\n          >\n            <FormGroup>\n              <ControlLabel>\n                <strong>column</strong>\n              </ControlLabel>\n              <Select\n                name=\"select-column\"\n                {...this.selectProps}\n                {...columnSelectProps}\n              />\n            </FormGroup>\n            <FormGroup>\n              <ControlLabel>\n                <strong>aggregate</strong>\n              </ControlLabel>\n              <Select\n                name=\"select-aggregate\"\n                {...this.selectProps}\n                {...aggregateSelectProps}\n                autoFocus\n              />\n            </FormGroup>\n          </Tab>\n          <Tab\n            className=\"adhoc-metric-edit-tab\"\n            eventKey={EXPRESSION_TYPES.SQL}\n            title=\"Custom SQL\"\n          >\n            {this.props.datasourceType !== 'druid' ? (\n              <FormGroup>\n                <AceEditor\n                  ref={this.handleAceEditorRef}\n                  mode=\"sql\"\n                  theme=\"github\"\n                  height={this.state.height - 43 + 'px'}\n                  onChange={this.onSqlExpressionChange}\n                  width=\"100%\"\n                  showGutter={false}\n                  value={\n                    adhocMetric.sqlExpression || adhocMetric.translateToSql()\n                  }\n                  editorProps={{ $blockScrolling: true }}\n                  enableLiveAutocompletion\n                  className=\"adhoc-filter-sql-editor\"\n                  wrapEnabled\n                />\n              </FormGroup>\n            ) : (\n              <div className=\"custom-sql-disabled-message\">\n                Custom SQL Metrics are not available on druid datasources\n              </div>\n            )}\n          </Tab>\n        </Tabs>\n        <div>\n          <Button\n            disabled={!stateIsValid}\n            bsStyle={hasUnsavedChanges && stateIsValid ? 'primary' : 'default'}\n            bsSize=\"small\"\n            className=\"m-r-5\"\n            onClick={this.onSave}\n          >\n            Save\n          </Button>\n          <Button bsSize=\"small\" onClick={this.props.onClose}>\n            Close\n          </Button>\n          <i\n            onMouseDown={this.onDragDown}\n            className=\"fa fa-expand edit-popover-resize text-muted\"\n          />\n        </div>\n      </Popover>\n    );\n  }\n}\nAdhocMetricEditPopover.propTypes = propTypes;\nAdhocMetricEditPopover.defaultProps = defaultProps;\n"]},"metadata":{},"sourceType":"module"}