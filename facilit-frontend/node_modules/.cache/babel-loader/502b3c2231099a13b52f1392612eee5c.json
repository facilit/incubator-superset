{"ast":null,"code":"import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _extends from \"@babel/runtime-corejs3/helpers/extends\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _concatInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/concat\";import _findIndexInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/find-index\";import _sliceInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/slice\";import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";var _jsxFileName = \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/controls/AnnotationLayerControl.jsx\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport {\nOverlayTrigger,\nPopover,\nListGroup,\nListGroupItem } from\n'react-bootstrap';\nimport { connect } from 'react-redux';\nimport { t } from '@superset-ui/translation';\nimport { InfoTooltipWithTrigger } from '@superset-ui/chart-controls';\nimport { getChartKey } from '../../exploreUtils';\nimport { runAnnotationQuery } from '../../../chart/chartAction';\n\nimport AnnotationLayer from './AnnotationLayer';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst propTypes = {\n  colorScheme: PropTypes.string.isRequired,\n  annotationError: PropTypes.object,\n  annotationQuery: PropTypes.object,\n  vizType: PropTypes.string,\n\n  validationErrors: PropTypes.array,\n  name: PropTypes.string.isRequired,\n  actions: PropTypes.object,\n  value: PropTypes.arrayOf(PropTypes.object),\n  onChange: PropTypes.func,\n  refreshAnnotationData: PropTypes.func };\n\n\nconst defaultProps = {\n  vizType: '',\n  value: [],\n  annotationError: {},\n  annotationQuery: {},\n  onChange: () => {} };\n\n\nclass AnnotationLayerControl extends React.PureComponent {\n  constructor(props) {var _context, _context2;\n    super(props);\n    this.addAnnotationLayer = _bindInstanceProperty(_context = this.addAnnotationLayer).call(_context, this);\n    this.removeAnnotationLayer = _bindInstanceProperty(_context2 = this.removeAnnotationLayer).call(_context2, this);\n  }\n\n  UNSAFE_componentWillReceiveProps(nextProps) {\n    const { name, annotationError, validationErrors, value } = nextProps;\n    if (_Object$keys(annotationError).length && !validationErrors.length) {\n      this.props.actions.setControlValue(\n      name,\n      value,\n      _Object$keys(annotationError));\n\n    }\n    if (!_Object$keys(annotationError).length && validationErrors.length) {\n      this.props.actions.setControlValue(name, value, []);\n    }\n  }\n\n  addAnnotationLayer(annotationLayer) {var _context3;\n    const annotation = annotationLayer;\n    let annotations = _sliceInstanceProperty(_context3 = this.props.value).call(_context3);\n    const i = _findIndexInstanceProperty(annotations).call(annotations,\n    x => x.name === (annotation.oldName || annotation.name));\n\n    delete annotation.oldName;\n    if (i > -1) {\n      annotations[i] = annotation;\n    } else {\n      annotations = _concatInstanceProperty(annotations).call(annotations, annotation);\n    }\n    this.props.refreshAnnotationData(annotation);\n    this.props.onChange(annotations);\n  }\n\n  removeAnnotationLayer(annotation) {var _context4, _context5;\n    const annotations = _filterInstanceProperty(_context4 = _sliceInstanceProperty(_context5 = this.props.value).call(_context5)).call(_context4,\n\n    x => x.name !== annotation.oldName);\n    this.props.onChange(annotations);\n  }\n\n  renderPopover(parent, annotation, error) {\n    const id = !annotation ? '_new' : annotation.name;\n    return (\n      ___EmotionJSX(Popover, {\n        style: { maxWidth: 'none' },\n        title:\n        annotation ? t('Edit Annotation Layer') : t('Add Annotation Layer'),\n\n        id: \"annotation-pop-\" + id, __source: { fileName: _jsxFileName, lineNumber: 104 }, __self: this },\n\n      ___EmotionJSX(AnnotationLayer, _extends({},\n      annotation, {\n        error: error,\n        colorScheme: this.props.colorScheme,\n        vizType: this.props.vizType,\n        addAnnotationLayer: this.addAnnotationLayer,\n        removeAnnotationLayer: this.removeAnnotationLayer,\n        close: () => this.refs[parent].hide(), __source: { fileName: _jsxFileName, lineNumber: 111 }, __self: this }))));\n\n\n\n  }\n\n  renderInfo(anno) {\n    const { annotationError, annotationQuery } = this.props;\n    if (annotationQuery[anno.name]) {\n      return (\n        ___EmotionJSX(\"i\", { className: \"fa fa-refresh\", style: { color: 'orange' }, \"aria-hidden\": true, __source: { fileName: _jsxFileName, lineNumber: 128 }, __self: this }));\n\n    }\n    if (annotationError[anno.name]) {\n      return (\n        ___EmotionJSX(InfoTooltipWithTrigger, {\n          label: \"validation-errors\",\n          bsStyle: \"danger\",\n          tooltip: annotationError[anno.name], __source: { fileName: _jsxFileName, lineNumber: 133 }, __self: this }));\n\n\n    }\n    if (!anno.show) {\n      return ___EmotionJSX(\"span\", { style: { color: 'red' }, __source: { fileName: _jsxFileName, lineNumber: 141 }, __self: this }, \" Hidden \");\n    }\n    return '';\n  }\n\n  render() {var _context6;\n    const annotations = _mapInstanceProperty(_context6 = this.props.value).call(_context6, (anno, i) =>\n    ___EmotionJSX(OverlayTrigger, {\n      key: i,\n      trigger: \"click\",\n      rootClose: true,\n      ref: \"overlay-\" + i,\n      placement: \"right\",\n      overlay: this.renderPopover(\"overlay-\" +\n      i,\n      anno,\n      this.props.annotationError[anno.name]), __source: { fileName: _jsxFileName, lineNumber: 148 }, __self: this },\n\n\n    ___EmotionJSX(ListGroupItem, { __source: { fileName: _jsxFileName, lineNumber: 160 }, __self: this },\n    ___EmotionJSX(\"span\", { __source: { fileName: _jsxFileName, lineNumber: 161 }, __self: this }, anno.name),\n    ___EmotionJSX(\"span\", { style: { float: 'right' }, __source: { fileName: _jsxFileName, lineNumber: 162 }, __self: this }, this.renderInfo(anno)))));\n\n\n\n    return (\n      ___EmotionJSX(\"div\", { __source: { fileName: _jsxFileName, lineNumber: 167 }, __self: this },\n      ___EmotionJSX(ListGroup, { __source: { fileName: _jsxFileName, lineNumber: 168 }, __self: this },\n      annotations,\n      ___EmotionJSX(OverlayTrigger, {\n        trigger: \"click\",\n        rootClose: true,\n        ref: \"overlay-new\",\n        placement: \"right\",\n        overlay: this.renderPopover('overlay-new'), __source: { fileName: _jsxFileName, lineNumber: 170 }, __self: this },\n\n      ___EmotionJSX(ListGroupItem, { __source: { fileName: _jsxFileName, lineNumber: 177 }, __self: this },\n      ___EmotionJSX(\"i\", { className: \"fa fa-plus\", __source: { fileName: _jsxFileName, lineNumber: 178 }, __self: this }), \" \\xA0 \", t('Add Annotation Layer'))))));\n\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}\nAnnotationLayerControl.propTypes = propTypes;\nAnnotationLayerControl.defaultProps = defaultProps;\n\n// Tried to hook this up through stores/control.jsx instead of using redux\n// directly, could not figure out how to get access to the color_scheme\nfunction mapStateToProps({ charts, explore }) {\n  const chartKey = getChartKey(explore);\n  const chart = charts[chartKey] || charts[0] || {};\n\n  return {\n    colorScheme: (explore.controls || {}).color_scheme.value,\n    annotationError: chart.annotationError,\n    annotationQuery: chart.annotationQuery,\n    vizType: explore.controls.viz_type.value };\n\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return {\n    refreshAnnotationData: (annotationLayer) =>\n    dispatch(runAnnotationQuery(annotationLayer)) };\n\n}const _default =\n\nconnect(\nmapStateToProps,\nmapDispatchToProps)(\nAnnotationLayerControl);export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(propTypes, \"propTypes\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/controls/AnnotationLayerControl.jsx\");reactHotLoader.register(defaultProps, \"defaultProps\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/controls/AnnotationLayerControl.jsx\");reactHotLoader.register(AnnotationLayerControl, \"AnnotationLayerControl\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/controls/AnnotationLayerControl.jsx\");reactHotLoader.register(mapStateToProps, \"mapStateToProps\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/controls/AnnotationLayerControl.jsx\");reactHotLoader.register(mapDispatchToProps, \"mapDispatchToProps\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/controls/AnnotationLayerControl.jsx\");reactHotLoader.register(_default, \"default\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/controls/AnnotationLayerControl.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/tiago/git-facilit/incubator-superset/superset-frontend/src/explore/components/controls/AnnotationLayerControl.jsx"],"names":["React","PropTypes","OverlayTrigger","Popover","ListGroup","ListGroupItem","connect","t","InfoTooltipWithTrigger","getChartKey","runAnnotationQuery","AnnotationLayer","propTypes","colorScheme","string","isRequired","annotationError","object","annotationQuery","vizType","validationErrors","array","name","actions","value","arrayOf","onChange","func","refreshAnnotationData","defaultProps","AnnotationLayerControl","PureComponent","constructor","props","addAnnotationLayer","removeAnnotationLayer","UNSAFE_componentWillReceiveProps","nextProps","length","setControlValue","annotationLayer","annotation","annotations","i","x","oldName","renderPopover","parent","error","id","maxWidth","refs","hide","renderInfo","anno","color","show","render","float","mapStateToProps","charts","explore","chartKey","chart","controls","color_scheme","viz_type","mapDispatchToProps","dispatch"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport {\n  OverlayTrigger,\n  Popover,\n  ListGroup,\n  ListGroupItem,\n} from 'react-bootstrap';\nimport { connect } from 'react-redux';\nimport { t } from '@superset-ui/translation';\nimport { InfoTooltipWithTrigger } from '@superset-ui/chart-controls';\nimport { getChartKey } from '../../exploreUtils';\nimport { runAnnotationQuery } from '../../../chart/chartAction';\n\nimport AnnotationLayer from './AnnotationLayer';\n\nconst propTypes = {\n  colorScheme: PropTypes.string.isRequired,\n  annotationError: PropTypes.object,\n  annotationQuery: PropTypes.object,\n  vizType: PropTypes.string,\n\n  validationErrors: PropTypes.array,\n  name: PropTypes.string.isRequired,\n  actions: PropTypes.object,\n  value: PropTypes.arrayOf(PropTypes.object),\n  onChange: PropTypes.func,\n  refreshAnnotationData: PropTypes.func,\n};\n\nconst defaultProps = {\n  vizType: '',\n  value: [],\n  annotationError: {},\n  annotationQuery: {},\n  onChange: () => {},\n};\n\nclass AnnotationLayerControl extends React.PureComponent {\n  constructor(props) {\n    super(props);\n    this.addAnnotationLayer = this.addAnnotationLayer.bind(this);\n    this.removeAnnotationLayer = this.removeAnnotationLayer.bind(this);\n  }\n\n  UNSAFE_componentWillReceiveProps(nextProps) {\n    const { name, annotationError, validationErrors, value } = nextProps;\n    if (Object.keys(annotationError).length && !validationErrors.length) {\n      this.props.actions.setControlValue(\n        name,\n        value,\n        Object.keys(annotationError),\n      );\n    }\n    if (!Object.keys(annotationError).length && validationErrors.length) {\n      this.props.actions.setControlValue(name, value, []);\n    }\n  }\n\n  addAnnotationLayer(annotationLayer) {\n    const annotation = annotationLayer;\n    let annotations = this.props.value.slice();\n    const i = annotations.findIndex(\n      x => x.name === (annotation.oldName || annotation.name),\n    );\n    delete annotation.oldName;\n    if (i > -1) {\n      annotations[i] = annotation;\n    } else {\n      annotations = annotations.concat(annotation);\n    }\n    this.props.refreshAnnotationData(annotation);\n    this.props.onChange(annotations);\n  }\n\n  removeAnnotationLayer(annotation) {\n    const annotations = this.props.value\n      .slice()\n      .filter(x => x.name !== annotation.oldName);\n    this.props.onChange(annotations);\n  }\n\n  renderPopover(parent, annotation, error) {\n    const id = !annotation ? '_new' : annotation.name;\n    return (\n      <Popover\n        style={{ maxWidth: 'none' }}\n        title={\n          annotation ? t('Edit Annotation Layer') : t('Add Annotation Layer')\n        }\n        id={`annotation-pop-${id}`}\n      >\n        <AnnotationLayer\n          {...annotation}\n          error={error}\n          colorScheme={this.props.colorScheme}\n          vizType={this.props.vizType}\n          addAnnotationLayer={this.addAnnotationLayer}\n          removeAnnotationLayer={this.removeAnnotationLayer}\n          close={() => this.refs[parent].hide()}\n        />\n      </Popover>\n    );\n  }\n\n  renderInfo(anno) {\n    const { annotationError, annotationQuery } = this.props;\n    if (annotationQuery[anno.name]) {\n      return (\n        <i className=\"fa fa-refresh\" style={{ color: 'orange' }} aria-hidden />\n      );\n    }\n    if (annotationError[anno.name]) {\n      return (\n        <InfoTooltipWithTrigger\n          label=\"validation-errors\"\n          bsStyle=\"danger\"\n          tooltip={annotationError[anno.name]}\n        />\n      );\n    }\n    if (!anno.show) {\n      return <span style={{ color: 'red' }}> Hidden </span>;\n    }\n    return '';\n  }\n\n  render() {\n    const annotations = this.props.value.map((anno, i) => (\n      <OverlayTrigger\n        key={i}\n        trigger=\"click\"\n        rootClose\n        ref={`overlay-${i}`}\n        placement=\"right\"\n        overlay={this.renderPopover(\n          `overlay-${i}`,\n          anno,\n          this.props.annotationError[anno.name],\n        )}\n      >\n        <ListGroupItem>\n          <span>{anno.name}</span>\n          <span style={{ float: 'right' }}>{this.renderInfo(anno)}</span>\n        </ListGroupItem>\n      </OverlayTrigger>\n    ));\n    return (\n      <div>\n        <ListGroup>\n          {annotations}\n          <OverlayTrigger\n            trigger=\"click\"\n            rootClose\n            ref=\"overlay-new\"\n            placement=\"right\"\n            overlay={this.renderPopover('overlay-new')}\n          >\n            <ListGroupItem>\n              <i className=\"fa fa-plus\" /> &nbsp; {t('Add Annotation Layer')}\n            </ListGroupItem>\n          </OverlayTrigger>\n        </ListGroup>\n      </div>\n    );\n  }\n}\n\nAnnotationLayerControl.propTypes = propTypes;\nAnnotationLayerControl.defaultProps = defaultProps;\n\n// Tried to hook this up through stores/control.jsx instead of using redux\n// directly, could not figure out how to get access to the color_scheme\nfunction mapStateToProps({ charts, explore }) {\n  const chartKey = getChartKey(explore);\n  const chart = charts[chartKey] || charts[0] || {};\n\n  return {\n    colorScheme: (explore.controls || {}).color_scheme.value,\n    annotationError: chart.annotationError,\n    annotationQuery: chart.annotationQuery,\n    vizType: explore.controls.viz_type.value,\n  };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return {\n    refreshAnnotationData: annotationLayer =>\n      dispatch(runAnnotationQuery(annotationLayer)),\n  };\n}\n\nexport default connect(\n  mapStateToProps,\n  mapDispatchToProps,\n)(AnnotationLayerControl);\n"]},"metadata":{},"sourceType":"module"}